<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>

        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Outlook Client (CVE-2023-23397) - Hacknum-Opus</title>
                

        <!-- Custom HTML head -->
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="SUMMARY.html"><strong aria-hidden="true">1.</strong> Table of Contents</a></li><li class="chapter-item expanded "><a href="SSH_HIJACKING_SUMMARY.html"><strong aria-hidden="true">2.</strong> SSH Hijacking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hijacking_ssh-agent_forwarding.html"><strong aria-hidden="true">2.1.</strong> SSH-Agent Forwarding</a></li><li class="chapter-item expanded "><a href="hijacking_ssh_controlmaster.html"><strong aria-hidden="true">2.2.</strong> ControlMaster</a></li></ol></li><li class="chapter-item expanded "><a href="REVERSE_SHELLS_SUMMARY.html"><strong aria-hidden="true">3.</strong> Reverse Shells</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="netcat_ssl.html"><strong aria-hidden="true">3.1.</strong> Netcat with SSL</a></li><li class="chapter-item expanded "><a href="upgrade_magic.html"><strong aria-hidden="true">3.2.</strong> Upgrading Shells with Magic</a></li></ol></li><li class="chapter-item expanded "><a href="C2_SUMMARY.html"><strong aria-hidden="true">4.</strong> C2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="C2_STEALTH_SUMMARY.html"><strong aria-hidden="true">4.1.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ja3_obfuscation.html"><strong aria-hidden="true">4.1.1.</strong> JA3 Obfuscation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WEB_SUMMARY.html"><strong aria-hidden="true">5.</strong> Web</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="GITLAB_SUMMARY.html"><strong aria-hidden="true">5.1.</strong> Gitlab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="gitlab-backdoor-user.html"><strong aria-hidden="true">5.1.1.</strong> Adding a Backdoor User</a></li><li class="chapter-item expanded "><a href="cve-2021-22205.html"><strong aria-hidden="true">5.1.2.</strong> ExifTool DjVu (CVE-2021-22205)</a></li><li class="chapter-item expanded "><a href="csproj.html"><strong aria-hidden="true">5.1.3.</strong> Visual Studio CSPROJ Reverse Shell</a></li></ol></li><li class="chapter-item expanded "><a href="PHP_SUMMARY.html"><strong aria-hidden="true">5.2.</strong> PHP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="php_webshell_oneline.html"><strong aria-hidden="true">5.2.1.</strong> Basic PHP Webshell Oneliner</a></li><li class="chapter-item expanded "><a href="php_filter_gadget_chain.html"><strong aria-hidden="true">5.2.2.</strong> PHP Filter Gadget Chain</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="LINUX_SUMMARY.html"><strong aria-hidden="true">6.</strong> Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LINUX_PRIVESC_SUMMARY.html"><strong aria-hidden="true">6.1.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux_gtfobins.html"><strong aria-hidden="true">6.1.1.</strong> SUDO/SUID/etc</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_SUMMARY.html"><strong aria-hidden="true">7.</strong> Windows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AMSI_BYPASS_SUMMARY.html"><strong aria-hidden="true">7.1.</strong> AMSI Bypass</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="powershell_amsi_bypass.html"><strong aria-hidden="true">7.1.1.</strong> Powershell AMSI Bypass</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_STEALTH_SUMMARY.html"><strong aria-hidden="true">7.2.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows_reflective_pe_loader.html"><strong aria-hidden="true">7.2.1.</strong> Reflective PE Loader</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_LATERAL_MOVEMENT_SUMMARY.html"><strong aria-hidden="true">7.3.</strong> Lateral Movement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="psexec.html"><strong aria-hidden="true">7.3.1.</strong> PSExec</a></li><li class="chapter-item expanded "><a href="mof_upload.html"><strong aria-hidden="true">7.3.2.</strong> MOF Upload</a></li><li class="chapter-item expanded "><a href="winrm.html"><strong aria-hidden="true">7.3.3.</strong> WinRM</a></li><li class="chapter-item expanded "><a href="printnightmare.html"><strong aria-hidden="true">7.3.4.</strong> PrintNightmare (CVE-2021-1675)</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PERSISTENCE_SUMMARY.html"><strong aria-hidden="true">7.4.</strong> Persistence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="invisreg.html"><strong aria-hidden="true">7.4.1.</strong> Invisible Registry Keys</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PRIVESC_SUMMARY.html"><strong aria-hidden="true">7.5.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cve-2023-23397.html" class="active"><strong aria-hidden="true">7.5.1.</strong> Outlook Client (CVE-2023-23397)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_SUMMARY.html"><strong aria-hidden="true">8.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sharpgpoabuse.html"><strong aria-hidden="true">8.1.</strong> SharpGPOAbuse</a></li><li class="chapter-item expanded "><a href="cert_template_abuse.html"><strong aria-hidden="true">8.2.</strong> Certificate Template Abuse</a></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html"><strong aria-hidden="true">8.3.</strong> Vulnerabilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zerologon.html"><strong aria-hidden="true">8.3.1.</strong> Zerologon (CVE-2020-1472)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="IMPACT_SUMMARY.html"><strong aria-hidden="true">9.</strong> Impact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="website_defacement.html"><strong aria-hidden="true">9.1.</strong> Website Defacement</a></li><li class="chapter-item expanded "><a href="gonnacope_(ransomware).html"><strong aria-hidden="true">9.2.</strong> GonnaCope</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="contrib.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="matrix">Matrix</button></li> 
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Hacknum-Opus</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="microsoft-outlook-client-appointment-reminder-alarm-sound---privilege-escalation-vulnerability-cve-2023-23397"><a class="header" href="#microsoft-outlook-client-appointment-reminder-alarm-sound---privilege-escalation-vulnerability-cve-2023-23397">Microsoft Outlook Client Appointment Reminder Alarm Sound - Privilege Escalation Vulnerability (CVE-2023-23397)</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>CVE-2023-23397 affects all versions of the Microsoft Outlook desktop applications on Windows systems. It is important to note that this vulnerability does not affect Outlook web app or Microsoft 365. The attacker can obtain a user's credentials and potentially escalate privileges by directing the Outlook client to <em><strong>search for the appointment reminder alarm sound on a specified UNC path, thereby leaking Net-NTLMv2 hashes</strong></em> when the victim machine authenticates to the server residing on the said UNC path. </p>
<p>Please refer to the <a href="https://www.cve.org/CVERecord?id=CVE-2023-23397">following</a> from CVE Records for which specific versions are vulnerable.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>The prerequisite for the setup is to have a Windows Active Directory environment set up with an Exchange server, and host workstation(s) with Microsoft Outlook client software installed. </p>
<blockquote>
<p>The range for testing the Proof of Concept was set up using Windows Server 2019, Exchange 2019, and Outlook Client 2019 installed on Windows 10</p>
</blockquote>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>First, install a Domain Controller. The instructions can be found <a href="https://www.virtualgyanis.com/post/step-by-step-how-to-install-and-configure-domain-controller-on-windows-server-2019">here.</a></p>
<p>Second, install Exchange.</p>
<ol>
<li>
<p>Download Exchange Server 2019 ISO from this <a href="https://www.microsoft.com/en-us/download/details.aspx?id=105713">link</a> on your Server 2019</p>
</li>
<li>
<p>In Server Manager click Add roles and features </p>
<ol>
<li>Click Next </li>
<li>Choose Role-based... and click Next </li>
<li>Click Next </li>
<li>Check AD LDS and click Next </li>
<li>Click Next until you have the option to install  </li>
<li>Check the Restart box and click Install </li>
<li>Click Close when it's available </li>
</ol>
</li>
<li>
<p>In Server Manager click on Tools and select AD LDS Setup Wizard </p>
<ol>
<li>Click Next for all defaults then click Finish </li>
</ol>
</li>
<li>
<p>Open PS as admin and run the following command </p>
<pre><code class="language-powershell">Install-WindowsFeature NET-Framework-45-Features, Server-Media-Foundation, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS
</code></pre>
</li>
<li>
<p>Install the prerequisites by following the instructions from this <a href="https://learn.microsoft.com/en-us/exchange/plan-and-deploy/prerequisites?view=exchserver-2019#exchange-2019-prerequisites-for-preparing-active-directory">link</a> and restart the box</p>
</li>
<li>
<p>Right-click on the Exchange Server 2019 ISO and select Mount</p>
</li>
<li>
<p>The new drive should open automatically, but open file explorer and open the DVD drive labeled ExchangeServer2019 if it doesn't open automatically.</p>
</li>
<li>
<p>Run Setup</p>
<ol>
<li>Select Don't check for updates right now and click next</li>
<li>Click next</li>
<li>Accept and click next</li>
<li>Select Use recommended settings and click next</li>
<li>Select Mailbox Role and Automatically... then click next</li>
<li>Click next</li>
<li>Enter an organization name of your choice and click next</li>
<li>Click next</li>
<li>If you installed all the prerequisites, the check should be successful. If it asks you to install additional features or packages, install them and continue</li>
<li>Click install, and the setup should take around 20 - 30 minutes</li>
<li>Click finish when complete and restart the box</li>
</ol>
</li>
<li>
<p>Test that the configuration is correct by sending e-mails internally</p>
<ol>
<li>Open a web browser and navigate to <code>https://ip-address-of-exchange-server-here/ecp</code></li>
<li>Login with your DC Admin credentials</li>
<li>Click the + sign and select User mailbox to create a user. You can create mailboxes for existing users in the domain, or vice versa -- you can create a new mailbox for a new user on the Exchange Server, which will create a user on the DC</li>
<li>Enter an Alias</li>
<li>Select New User and enter appropriate information in the fields</li>
<li>Click Browse under Organizational Unit and select Users, then click Save</li>
<li>Navigate to <code>https://ip-address-of-exchange-server-here/owa</code> and send a test e-mail to the new user.</li>
<li>Sign out from the Administrator, and sign back in as the newly created user to verify that the e-mails can be sent back and forth.</li>
</ol>
</li>
<li>
<p>Open Windows Firewall</p>
<ol>
<li>Create Inbound and Outbound rules that allow:
<ol>
<li>Ports 25, 389, 50636</li>
<li>ICMP (for debugging purposes, if needed)</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Third, set up workstations with Outlook 2019 Clients.</p>
<ol>
<li>Join your workstation to the AD environment you set up above. <code>Note: Ensure that you assign a DNS server as the DC</code></li>
<li>Install Microsoft Office 2019
<ol>
<li>Microsoft Office 2019, as well as any activation needed can be found on this <a href="https://github.com/tylerdotrar/Activate-MicrosoftOffice">github repo</a></li>
<li>Upon opening Outlook, enter the e-mail address of the new account you created earlier, and click Advanced Options &gt; Let me set up my account manually &gt; Connect
<ol>
<li>Select Exchange (Not Exchange 2013 or earlier)</li>
</ol>
</li>
</ol>
</li>
<li>Make sure you can send and receive e-mails by communicating with the Exchange Server.</li>
</ol>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<h3 id="method-1---powershell-script"><a class="header" href="#method-1---powershell-script">Method 1 - PowerShell Script</a></h3>
<p>The POC PowerShell script can be found <a href="https://github.com/ka7ana/CVE-2023-23397">here</a>. All that is required is that you change the recipient's e-mail address, and the UNC path</p>
<p><img src="./images/Pasted%20image%2020240118131309.png" alt="image" /></p>
<p><code>Note: The listening server doesn't necessarily need to be an SMB share. You can use things like Responder tool as well</code></p>
<h4 id="indicators-of-compromise"><a class="header" href="#indicators-of-compromise">Indicators of Compromise</a></h4>
<ul>
<li>PowerShell execution logs</li>
<li>NTLM hash traveling to an external network </li>
<li>Authentication request via UNC path</li>
</ul>
<h3 id="method-2---sending-appointments-on-outlook-client"><a class="header" href="#method-2---sending-appointments-on-outlook-client">Method 2 - Sending Appointments On Outlook Client</a></h3>
<ol>
<li>
<p>On the Outlook client, click New Items -&gt; Appointment 
<img src="./images/Pasted%20image%2020240118131751.png" alt="image" /></p>
</li>
<li>
<p>Manually select the sound file (to be played upon receiving the appointment reminder e-mail) and enter the UNC Path to the server </p>
<p><img src="./images/Pasted%20image%2020240118131906.png" alt="image" />
<img src="./images/Pasted%20image%2020240118132014.png" alt="image" /></p>
</li>
</ol>
<h4 id="indicators-of-compromise-1"><a class="header" href="#indicators-of-compromise-1">Indicators of Compromise</a></h4>
<ul>
<li>NTLM hash traveling to an external network </li>
<li>Authentication request via UNC path</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="WINDOWS_PRIVESC_SUMMARY.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="ACTIVE_DIRECTORY_SUMMARY.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="WINDOWS_PRIVESC_SUMMARY.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="ACTIVE_DIRECTORY_SUMMARY.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script>
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        
        
    </div>
    </body>
</html>
