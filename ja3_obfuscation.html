<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>

        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>JA3 Obfuscation - Hacknum-Opus</title>
                

        <!-- Custom HTML head -->
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="SUMMARY.html"><strong aria-hidden="true">1.</strong> Table of Contents</a></li><li class="chapter-item expanded "><a href="SSH_HIJACKING_SUMMARY.html"><strong aria-hidden="true">2.</strong> SSH Hijacking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hijacking_ssh-agent_forwarding.html"><strong aria-hidden="true">2.1.</strong> SSH-Agent Forwarding</a></li><li class="chapter-item expanded "><a href="hijacking_ssh_controlmaster.html"><strong aria-hidden="true">2.2.</strong> ControlMaster</a></li></ol></li><li class="chapter-item expanded "><a href="REVERSE_SHELLS_SUMMARY.html"><strong aria-hidden="true">3.</strong> Reverse Shells</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="netcat_ssl.html"><strong aria-hidden="true">3.1.</strong> Netcat with SSL</a></li><li class="chapter-item expanded "><a href="upgrade_magic.html"><strong aria-hidden="true">3.2.</strong> Upgrading Shells with Magic</a></li></ol></li><li class="chapter-item expanded "><a href="C2_SUMMARY.html"><strong aria-hidden="true">4.</strong> C2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="C2_STEALTH_SUMMARY.html"><strong aria-hidden="true">4.1.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ja3_obfuscation.html" class="active"><strong aria-hidden="true">4.1.1.</strong> JA3 Obfuscation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WEB_SUMMARY.html"><strong aria-hidden="true">5.</strong> Web</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="GITLAB_SUMMARY.html"><strong aria-hidden="true">5.1.</strong> Gitlab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="gitlab-backdoor-user.html"><strong aria-hidden="true">5.1.1.</strong> Adding a Backdoor User</a></li><li class="chapter-item expanded "><a href="cve-2021-22205.html"><strong aria-hidden="true">5.1.2.</strong> ExifTool DjVu (CVE-2021-22205)</a></li><li class="chapter-item expanded "><a href="csproj.html"><strong aria-hidden="true">5.1.3.</strong> Visual Studio CSPROJ Reverse Shell</a></li></ol></li><li class="chapter-item expanded "><a href="PHP_SUMMARY.html"><strong aria-hidden="true">5.2.</strong> PHP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="php_webshell_oneline.html"><strong aria-hidden="true">5.2.1.</strong> Basic PHP Webshell Oneliner</a></li><li class="chapter-item expanded "><a href="php_filter_gadget_chain.html"><strong aria-hidden="true">5.2.2.</strong> PHP Filter Gadget Chain</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="LINUX_SUMMARY.html"><strong aria-hidden="true">6.</strong> Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LINUX_PRIVESC_SUMMARY.html"><strong aria-hidden="true">6.1.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux_gtfobins.html"><strong aria-hidden="true">6.1.1.</strong> SUDO/SUID/etc</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_SUMMARY.html"><strong aria-hidden="true">7.</strong> Windows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AMSI_BYPASS_SUMMARY.html"><strong aria-hidden="true">7.1.</strong> AMSI Bypass</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="powershell_amsi_bypass.html"><strong aria-hidden="true">7.1.1.</strong> Powershell AMSI Bypass</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_STEALTH_SUMMARY.html"><strong aria-hidden="true">7.2.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows_reflective_pe_loader.html"><strong aria-hidden="true">7.2.1.</strong> Reflective PE Loader</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_LATERAL_MOVEMENT_SUMMARY.html"><strong aria-hidden="true">7.3.</strong> Lateral Movement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="psexec.html"><strong aria-hidden="true">7.3.1.</strong> PSExec</a></li><li class="chapter-item expanded "><a href="mof_upload.html"><strong aria-hidden="true">7.3.2.</strong> MOF Upload</a></li><li class="chapter-item expanded "><a href="winrm.html"><strong aria-hidden="true">7.3.3.</strong> WinRM</a></li><li class="chapter-item expanded "><a href="printnightmare.html"><strong aria-hidden="true">7.3.4.</strong> PrintNightmare (CVE-2021-1675)</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PERSISTENCE_SUMMARY.html"><strong aria-hidden="true">7.4.</strong> Persistence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="invisreg.html"><strong aria-hidden="true">7.4.1.</strong> Invisible Registry Keys</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PRIVESC_SUMMARY.html"><strong aria-hidden="true">7.5.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cve-2023-23397.html"><strong aria-hidden="true">7.5.1.</strong> Outlook Client (CVE-2023-23397)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_SUMMARY.html"><strong aria-hidden="true">8.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sharpgpoabuse.html"><strong aria-hidden="true">8.1.</strong> SharpGPOAbuse</a></li><li class="chapter-item expanded "><a href="cert_template_abuse.html"><strong aria-hidden="true">8.2.</strong> Certificate Template Abuse</a></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html"><strong aria-hidden="true">8.3.</strong> Vulnerabilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zerologon.html"><strong aria-hidden="true">8.3.1.</strong> Zerologon (CVE-2020-1472)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="IMPACT_SUMMARY.html"><strong aria-hidden="true">9.</strong> Impact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="website_defacement.html"><strong aria-hidden="true">9.1.</strong> Website Defacement</a></li><li class="chapter-item expanded "><a href="gonnacope_(ransomware).html"><strong aria-hidden="true">9.2.</strong> GonnaCope</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="contrib.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="matrix">Matrix</button></li> 
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Hacknum-Opus</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="obfuscating-ja3-hashes-with-haproxy"><a class="header" href="#obfuscating-ja3-hashes-with-haproxy">Obfuscating JA3 Hashes with HAProxy</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>JA3 fingerprinting is a methodology for identifying attributes about a TLS connection and representing that information with an MD5 hash. These hashes can used to identify non-standard and potentially malicious traffic on a network. For example, the JA3 hash for most legitimate web traffic will be identical, whereas that of C2 traffic could either be unique and thus questionable, or exactly the same as other known C2 signatures and easily identifiable. While not exceptionally reliable, this is often used as a detection rule for intrusion detection systems (such as Suricata), or as an analytic for data driven monitoring and so should be obfuscated if possible.</p>
<p>The solution to the abnormal JA3 hashes produced by C2 traffic is to encapsulate it within HTTPS traffic directed towards a load balancer. The load balancer will then redirect the encapsulated C2 traffic to the C2 server, and when the C2 server reaches back to the load balancer it will once again get redirected under the guise of legitimate traffic. Since load balancers are very common technologies within web stacks, this will allow the JA3 hash of C2 traffic to blend in with normal web traffic. Furthermore, since this is a layer in front of the C2 server, it should be platform agnostic provided that the C2 platform supports HTTPS beaconing.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li>Linux VM (Ideally with the apt package manager)</li>
<li>A C2 server (Can be running on the aforementioned Linux VM)</li>
</ul>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<h3 id="initial-setup"><a class="header" href="#initial-setup">Initial Setup</a></h3>
<ol>
<li>Install haproxy via your distribution's package manager (<code>sudo apt-get install haproxy</code> with apt) </li>
<li>Open the haproxy configuration file at <code>/etc/haproxy/haproxy.cfg</code> using your text editor of choice</li>
</ol>
<pre><code>The file layout will look like this:
====

global
	xxxx
	xxxx

defaults
	xxxx
	xxxx

====

For the purposes of this guide, the non-tabbed portions (global and default) will be referred to as sections. You can ignore the two existing sections, but editing them may be useful for fine tuning.
</code></pre>
<ol start="3">
<li>At the bottom of the file, add a new section called <code>frontend myfrontend</code> and format it as laid out below. This will be the address and port that the load balancer is listening for traffic on.</li>
</ol>
<pre><code>defaults
	xxxx
	xxxx

frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:8080
</code></pre>
<ol start="4">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>, if you see any errors you likely have a syntax error.</li>
<li>Verify that your configuration is working by running <code>curl 127.0.0.1:8080</code>. This command should return a <code>503 Service Unavailable &quot;No server is available to handle this request.&quot;</code> error.</li>
<li>Re-open the configuration file and add the following configuration at the end of the file. This will be the destination where traffic will be redirected to.</li>
</ol>
<pre><code>frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:8080

backend myserver
	server server1 127.0.0.1:8000
</code></pre>
<ol start="7">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>.</li>
<li>In another terminal/tab, start a python webserver with the command <code>python3 -m http.server --bind 127.0.0.1 8000</code>.</li>
<li>Verify the redirection using <code>curl 127.0.0.1:8080</code>. The output of this command should be the filenames in the directory where the webserver is being hosted. If you are still getting a <code>503 Service Unavailable</code> error, ensure that you have the <code>default_backend</code> under the <code>frontend</code> section set correctly.</li>
<li>You can now redirect unencrypted HTTP traffic by adjusting the frontend and backend values.</li>
</ol>
<h3 id="generating-ssl-certificates"><a class="header" href="#generating-ssl-certificates">Generating SSL Certificates</a></h3>
<ol>
<li>Generate a private key using `openssl genpkey -algorithm RSA -out pkey.pem.</li>
<li>Generate a certificate signing request using <code>openssl req -new -key pkey.pem -out csr.pem</code>.</li>
<li>Generate a self signed certificate using `openssl x509 -req -days 365 -in csr.pem -signkey pkey.pem -out cert.pem.</li>
<li>Create a new file using <code>touch tls.pem</code>.</li>
<li>Add the cert.pem to tls.pem using <code>cat cert.pem &gt;&gt; tls.pem</code>.</li>
<li>Add the private key information to tls.pem using <code>sudo cat pkey.pem &gt;&gt; tls.pem</code>.</li>
</ol>
<h3 id="configuring-tls"><a class="header" href="#configuring-tls">Configuring TLS</a></h3>
<ol>
<li>Open the configuration file from earlier and modify the following lines. This will change the frontend bind address to be any interface on port 443, and will assign the listed ssl cert to the port.</li>
</ol>
<pre><code>frontend myfrontend
	default_backend myserver
	bind 0.0.0.0:443 ssl cert /path/to/tls.pem

</code></pre>
<ol start="2">
<li>Save and exit the configuration file and restart HAProxy using <code>systemctl restart haproxy</code>. If you get an error, ensure that you properly combined the two .pem files from earlier into a single file, and that your path is correct.</li>
</ol>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<h3 id="method-1---utilizing-haproxy"><a class="header" href="#method-1---utilizing-haproxy">Method 1 - Utilizing HAProxy</a></h3>
<ol>
<li>Modify the configuration file from earlier to be representative of your listener address as follows (the pound signs are just comments).</li>
</ol>
<pre><code>backend myserver
	server server1 127.0.0.1:6969
	# ^ Your C2 listener will be set up on this port (6969) 
</code></pre>
<ol start="2">
<li>Generate an http/s (https if your platform supports it) beacon pointing towards the server running HAProxy and your C2 server at the port defined in your frontend section (443 using the example from setup)</li>
<li>Set up an http/s listener on your C2 server listening on the port defined in the backend section (6969 using the example from earlier)</li>
<li>Execute your beacon on a target box and ensure you get a callback. If you want to verify that the traffic is TLS, observe the traffic in wireshark and ensure that you are seeing a <code>Client Hello</code> followed by a <code>Server Hello</code> pointed towards the HAProxy frontend address and port. Wireshark should also show you the JA3 hash.</li>
</ol>
<h4 id="indicators-of-compromise"><a class="header" href="#indicators-of-compromise">Indicators of Compromise</a></h4>
<p>The indicators of compromise for this action would be the same as HTTPS beaconing, but it should help in defeating JA3 hash based detection. The traffic will likely be using a self signed SSL certificate, which may be an indicator that the destination is illegitimate.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="C2_STEALTH_SUMMARY.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="WEB_SUMMARY.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="C2_STEALTH_SUMMARY.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="WEB_SUMMARY.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script>
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        
        
    </div>
    </body>
</html>
