<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>

        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ControlMaster - Hacknum-Opus</title>
                

        <!-- Custom HTML head -->
        

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="SUMMARY.html"><strong aria-hidden="true">1.</strong> Table of Contents</a></li><li class="chapter-item expanded "><a href="SSH_HIJACKING_SUMMARY.html"><strong aria-hidden="true">2.</strong> SSH Hijacking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hijacking_ssh-agent_forwarding.html"><strong aria-hidden="true">2.1.</strong> SSH-Agent Forwarding</a></li><li class="chapter-item expanded "><a href="hijacking_ssh_controlmaster.html" class="active"><strong aria-hidden="true">2.2.</strong> ControlMaster</a></li></ol></li><li class="chapter-item expanded "><a href="REVERSE_SHELLS_SUMMARY.html"><strong aria-hidden="true">3.</strong> Reverse Shells</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="netcat_ssl.html"><strong aria-hidden="true">3.1.</strong> Netcat with SSL</a></li><li class="chapter-item expanded "><a href="upgrade_magic.html"><strong aria-hidden="true">3.2.</strong> Upgrading Shells with Magic</a></li></ol></li><li class="chapter-item expanded "><a href="WEB_SUMMARY.html"><strong aria-hidden="true">4.</strong> Web</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="GITLAB_SUMMARY.html"><strong aria-hidden="true">4.1.</strong> Gitlab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cve-2021-22205.html"><strong aria-hidden="true">4.1.1.</strong> ExifTool DjVu (CVE-2021-22205)</a></li></ol></li><li class="chapter-item expanded "><a href="PHP_SUMMARY.html"><strong aria-hidden="true">4.2.</strong> PHP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="php_webshell_oneline.html"><strong aria-hidden="true">4.2.1.</strong> Basic PHP Webshell Oneliner</a></li><li class="chapter-item expanded "><a href="php_filter_gadget_chain.html"><strong aria-hidden="true">4.2.2.</strong> PHP Filter Gadget Chain</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="LINUX_SUMMARY.html"><strong aria-hidden="true">5.</strong> Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LINUX_PRIVESC_SUMMARY.html"><strong aria-hidden="true">5.1.</strong> Privilege Escalation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux_gtfobins.html"><strong aria-hidden="true">5.1.1.</strong> SUDO/SUID/etc</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_SUMMARY.html"><strong aria-hidden="true">6.</strong> Windows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AMSI_BYPASS_SUMMARY.html"><strong aria-hidden="true">6.1.</strong> AMSI Bypass</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="powershell_amsi_bypass.html"><strong aria-hidden="true">6.1.1.</strong> Powershell AMSI Bypass</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_STEALTH_SUMMARY.html"><strong aria-hidden="true">6.2.</strong> Stealth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows_reflective_pe_loader.html"><strong aria-hidden="true">6.2.1.</strong> Reflective PE Loader</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_LATERAL_MOVEMENT_SUMMARY.html"><strong aria-hidden="true">6.3.</strong> Lateral Movement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="psexec.html"><strong aria-hidden="true">6.3.1.</strong> PSExec</a></li><li class="chapter-item expanded "><a href="mof_upload.html"><strong aria-hidden="true">6.3.2.</strong> MOF Upload</a></li><li class="chapter-item expanded "><a href="winrm.html"><strong aria-hidden="true">6.3.3.</strong> WinRM</a></li><li class="chapter-item expanded "><a href="printnightmare.html"><strong aria-hidden="true">6.3.4.</strong> PrintNightmare (CVE-2021-1675)</a></li></ol></li><li class="chapter-item expanded "><a href="WINDOWS_PERSISTENCE_SUMMARY.html"><strong aria-hidden="true">6.4.</strong> Persistence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="invisreg.html"><strong aria-hidden="true">6.4.1.</strong> Invisible Registry Keys</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_SUMMARY.html"><strong aria-hidden="true">7.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sharpgpoabuse.html"><strong aria-hidden="true">7.1.</strong> SharpGPOAbuse</a></li><li class="chapter-item expanded "><a href="cert_template_abuse.html"><strong aria-hidden="true">7.2.</strong> Certificate Template Abuse</a></li><li class="chapter-item expanded "><a href="ACTIVE_DIRECTORY_VULNERABILITIES_SUMMARY.html"><strong aria-hidden="true">7.3.</strong> Vulnerabilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zerologon.html"><strong aria-hidden="true">7.3.1.</strong> Zerologon (CVE-2020-1472)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="IMPACT_SUMMARY.html"><strong aria-hidden="true">8.</strong> Impact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="website_defacement.html"><strong aria-hidden="true">8.1.</strong> Website Defacement</a></li><li class="chapter-item expanded "><a href="gonnacope_(ransomware).html"><strong aria-hidden="true">8.2.</strong> GonnaCope</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="contrib.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="matrix">Matrix</button></li> 
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Hacknum-Opus</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hijacking-ssh-with-controlmaster"><a class="header" href="#hijacking-ssh-with-controlmaster">Hijacking SSH With ControlMaster</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>ControlMaster is a feature that enables sharing of multiple SSH sessions over a single network connection. This functionality can be enabled for a given user by editing their local SSH configuration file in ~/.ssh/config. This will create a socket that can be used without authentication on the client.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>A client must have SSH installed, with the ability to configure ControlMaster, and the connection must have been made at least once depending on the ControlPersist setting used.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>To configure ControlMaster, place the following into the clients local SSH config, located at ~/.ssh/config:</p>
<pre><code class="language-config">Host *
        ControlPath ~/.ssh/controlmaster/%r@%h:%p
        ControlMaster auto
        ControlPersist 10m
</code></pre>
<p>if ControlPersist is set to yes, it will never close even when the SSH connection is closed. Otherwise, it will last for the duration this is set to after the connection is closed.</p>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<h3 id="method-1---using-the-controlmaster-socket"><a class="header" href="#method-1---using-the-controlmaster-socket">Method 1 - Using the ControlMaster Socket</a></h3>
<p>To abuse this, run the following command on the client to hijack the ControlMaster socket:</p>
<pre><code class="language-bash">ssh -S /home/user/.ssh/controlmaster/user\@target\:port user@target
</code></pre>
<h4 id="indicators-of-compromise"><a class="header" href="#indicators-of-compromise">Indicators of Compromise</a></h4>
<p>TODO</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="hijacking_ssh-agent_forwarding.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="REVERSE_SHELLS_SUMMARY.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="hijacking_ssh-agent_forwarding.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="REVERSE_SHELLS_SUMMARY.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script>
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        
        
    </div>
    </body>
</html>
